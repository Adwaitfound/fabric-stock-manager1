<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fabric Stock Manager</title>
    <!-- REMOVED EXTERNAL TAILWIND SCRIPT -->
    <style>
        /* BASE STYLES & FONTS */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&display=swap');

        body {
            font-family: 'Inter', sans-serif;
            background-color: #f9fafb;
            min-height: 100vh;
            padding: 1rem;
        }

        /* UTILITY CLASSES (Hardcoded Tailwind) */
        .max-w-6xl {
            max-width: 72rem;
        }

        .mx-auto {
            margin-left: auto;
            margin-right: auto;
        }

        .p-4 {
            padding: 1rem;
        }

        .md\:p-8 {
            padding: 2rem;
        }

        .min-h-screen {
            min-height: 100vh;
        }

        .bg-gray-50 {
            background-color: #f9fafb;
        }

        .font-sans {
            font-family: 'Inter', sans-serif;
        }

        .mb-2 {
            margin-bottom: 0.5rem;
        }

        .mb-6 {
            margin-bottom: 1.5rem;
        }

        .mb-8 {
            margin-bottom: 2rem;
        }

        .mt-1 {
            margin-top: 0.25rem;
        }

        .mt-2 {
            margin-top: 0.5rem;
        }

        .mr-2 {
            margin-right: 0.5rem;
        }

        .mr-3 {
            margin-right: 0.75rem;
        }

        .mr-4 {
            margin-right: 1rem;
        }

        .ml-1 {
            margin-left: 0.25rem;
        }

        .ml-2 {
            margin-left: 0.5rem;
        }

        .ml-4 {
            margin-left: 1rem;
        }

        .space-x-2>*+* {
            margin-left: 0.5rem;
        }

        .space-y-1>*+* {
            margin-top: 0.25rem;
        }

        .space-y-3>*+* {
            margin-top: 0.75rem;
        }

        .pt-2 {
            padding-top: 0.5rem;
        }

        .px-3 {
            padding-left: 0.75rem;
            padding-right: 0.75rem;
        }

        .px-4 {
            padding-left: 1rem;
            padding-right: 1rem;
        }

        .py-2 {
            padding-top: 0.5rem;
            padding-bottom: 0.5rem;
        }

        .p-1 {
            padding: 0.25rem;
        }

        .p-2 {
            padding: 0.5rem;
        }

        .p-3 {
            padding: 0.75rem;
        }

        .p-5 {
            padding: 1.25rem;
        }

        .p-6 {
            padding: 1.5rem;
        }

        .p-8 {
            padding: 2rem;
        }

        .text-center {
            text-align: center;
        }

        /* LAYOUT AND DISPLAY */
        .flex {
            display: flex;
        }

        .hidden {
            display: none;
        }

        .items-center {
            align-items: center;
        }

        .justify-center {
            justify-content: center;
        }

        .justify-between {
            justify-content: space-between;
        }

        .flex-col {
            flex-direction: column;
        }

        .flex-1 {
            flex: 1 1 0%;
        }

        .block {
            display: block;
        }

        .inline-flex {
            display: inline-flex;
        }

        .grid {
            display: grid;
        }

        .gap-4 {
            gap: 1rem;
        }

        .gap-6 {
            gap: 1.5rem;
        }

        .rounded-md {
            border-radius: 0.375rem;
        }

        .rounded-lg {
            border-radius: 0.5rem;
        }

        .rounded-xl {
            border-radius: 0.75rem;
        }

        .rounded-l-md {
            border-top-left-radius: 0.375rem;
            border-bottom-left-radius: 0.375rem;
        }

        .rounded-r-md {
            border-top-right-radius: 0.375rem;
            border-bottom-right-radius: 0.375rem;
        }

        .w-full {
            width: 100%;
        }

        .w-5 {
            width: 1.25rem;
        }

        .w-6 {
            width: 1.5rem;
        }

        .w-8 {
            width: 2rem;
        }

        .w-20 {
            width: 5rem;
        }

        .h-4 {
            height: 1rem;
        }

        .h-5 {
            height: 1.25rem;
        }

        .h-6 {
            height: 1.5rem;
        }

        .h-8 {
            height: 2rem;
        }

        .h-20 {
            height: 5rem;
        }

        .shadow-sm {
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        }

        .shadow-md {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
        }

        .shadow-lg {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.1);
        }

        .shadow-inner {
            box-shadow: inset 0 2px 4px 0 rgba(0, 0, 0, 0.06);
        }

        .object-cover {
            object-fit: cover;
        }

        .border {
            border-width: 1px;
        }

        .border-l-4 {
            border-left-width: 4px;
        }

        .border-l-0 {
            border-left-width: 0px;
        }

        .border-gray-200 {
            border-color: #e5e7eb;
        }

        .border-gray-300 {
            border-color: #d1d5db;
        }

        .border-red-300 {
            border-color: #fca5a5;
        }

        .border-yellow-300 {
            border-color: #fcd34d;
        }

        .border-transparent {
            border-color: transparent;
        }

        /* TEXT AND COLORS */
        .text-xs {
            font-size: 0.75rem;
        }

        .text-sm {
            font-size: 0.875rem;
        }

        .text-base {
            font-size: 1rem;
        }

        .text-xl {
            font-size: 1.25rem;
        }

        .text-2xl {
            font-size: 1.5rem;
        }

        .text-3xl {
            font-size: 1.875rem;
        }

        .text-4xl {
            font-size: 2.25rem;
        }

        .text-gray-900 {
            color: #111827;
        }

        .text-gray-800 {
            color: #1f2937;
        }

        .text-gray-700 {
            color: #374151;
        }

        .text-gray-600 {
            color: #4b5563;
        }

        .text-gray-500 {
            color: #6b7280;
        }

        .text-gray-400 {
            color: #9ca3af;
        }

        .text-blue-500 {
            color: #3b82f6;
        }

        .text-blue-600 {
            color: #2563eb;
        }

        .text-blue-700 {
            color: #1d4ed8;
        }

        .text-green-500 {
            color: #10b981;
        }

        .text-green-600 {
            color: #059669;
        }

        .text-green-100 {
            background-color: #d1fae5;
        }

        .text-green-700 {
            color: #047857;
        }

        .text-red-600 {
            color: #dc2626;
        }

        .text-red-700 {
            color: #b91c1c;
        }

        .text-red-100 {
            background-color: #fee2e2;
        }

        .text-white {
            color: #ffffff;
        }

        .bg-white {
            background-color: #ffffff;
        }

        .bg-blue-50 {
            background-color: #eff6ff;
        }

        .bg-blue-100 {
            background-color: #dbeafe;
        }

        .bg-blue-500 {
            background-color: #3b82f6;
        }

        .bg-green-500 {
            background-color: #10b981;
        }

        .bg-yellow-400 {
            background-color: #facc15;
        }

        .bg-yellow-500 {
            background-color: #f59e0b;
        }

        .bg-gray-100 {
            background-color: #f3f4f6;
        }

        .bg-gray-200 {
            background-color: #e5e7eb;
        }

        .bg-gray-300 {
            background-color: #d1d5db;
        }

        .bg-red-100 {
            background-color: #fee2e2;
        }

        .bg-red-500 {
            border-color: #ef4444;
        }

        .bg-indigo-100 {
            background-color: #e0e7ff;
        }

        .bg-indigo-800 {
            color: #3730a3;
        }

        .font-bold {
            font-weight: 700;
        }

        .font-extrabold {
            font-weight: 800;
        }

        .font-medium {
            font-weight: 500;
        }

        .font-semibold {
            font-weight: 600;
        }

        .font-mono {
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
        }

        .opacity-80 {
            opacity: 0.8;
        }

        .uppercase {
            text-transform: uppercase;
        }

        /* INTERACTION & FORM */
        .cursor-not-allowed {
            cursor: not-allowed;
        }

        .focus\:ring-blue-500:focus {
            --tw-ring-color: #3b82f6;
            ring-width: 2px;
        }

        .focus\:border-blue-500:focus {
            border-color: #3b82f6;
        }

        .hover\:bg-blue-700:hover {
            background-color: #1d4ed8;
        }

        .hover\:bg-blue-500:hover {
            background-color: #3b82f6;
        }

        .hover\:bg-yellow-500:hover {
            background-color: #f59e0b;
        }

        .hover\:bg-yellow-600:hover {
            background-color: #d97706;
        }

        .hover\:bg-red-200:hover {
            background-color: #fecaca;
        }

        .hover\:bg-gray-400:hover {
            background-color: #9ca3af;
        }

        .hover\:bg-blue-200:hover {
            background-color: #bfdbfe;
        }

        .hover\:bg-indigo-200:hover {
            background-color: #c7d2fe;
        }

        /* LOADING */
        .loading-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #3b82f6;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* RESPONSIVENESS */
        @media (min-width: 768px) {
            .md\:p-8 {
                padding: 2rem;
            }

            .md\:flex-row {
                flex-direction: row;
            }

            .md\:items-center {
                align-items: center;
            }

            .md\:mb-0 {
                margin-bottom: 0;
            }

            .md\:w-3\/5 {
                width: 60%;
            }

            .md\:w-2\/5 {
                width: 40%;
            }

            .md\:grid-cols-2 {
                grid-template-columns: repeat(2, minmax(0, 1fr));
            }

            .lg\:grid-cols-3 {
                grid-template-columns: repeat(3, minmax(0, 1fr));
            }

            .col-span-1 {
                grid-column: span 1 / span 1;
            }

            .col-span-2 {
                grid-column: span 2 / span 2;
            }

            .col-span-3 {
                grid-column: span 3 / span 3;
            }
        }
    </style>
</head>

<body>
    <div id="root">
        <div class="loading-container">
            <div class="spinner mr-3"></div>
            <div class="text-xl font-medium text-blue-500">Loading Application...</div>
        </div>
    </div>

    <!-- ---------------------------------------------------- -->
    <!-- FIREBASE AND REACT SCRIPTS -->
    <!-- ---------------------------------------------------- -->

    <!-- Firebase SDKs are loaded from CDN for Auth and Firestore -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, doc, setDoc, deleteDoc, query, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Expose Firebase modules to the global window object for the Babel script to use
        window.firebase = {
            initializeApp, getAuth, signInAnonymously, onAuthStateChanged,
            getFirestore, collection, onSnapshot, doc, setDoc, deleteDoc, query, serverTimestamp
        };
        window.FIREBASE_MODULES_LOADED = true;
    </script>

    <!-- React and Babel for JSX in browser -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script type="text/babel">
        // ----------------------------------------------------
        // FIREBASE CONFIGURATION (INJECTED)
        // ----------------------------------------------------
        const FIREBASE_CONFIG = {
            // UPDATED KEYS FOR NEW PROJECT: poshakh-fabric-final
            apiKey: "AIzaSyA-iTofFK-Y1QZtmVs-yzpEWiEzyfBHuu4",
            authDomain: "poshakh-fabric-final.firebaseapp.com",
            projectId: "poshakh-fabric-final",
            storageBucket: "poshakh-fabric-final.firebasestorage.app",
            messagingSenderId: "372598853447",
            appId: "1:372598853447:web:5d177d6bdc5066c02c0662"
        };

        // --- Firestore Collection Path ---
        // Shared public path for all teams accessing the app
        const COLLECTION_PATH = 'artifacts/poshakh-fabric-manager/public/data/fabrics';
        const APP_ID = 'poshakh-fabric-manager'; // Used for the artifacts path

        // Icons (simplified from lucide-react for single-file HTML)
        const Plus = (props) => <svg {...props} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>;
        const Trash2 = (props) => <svg {...props} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6"></path><path d="M10 11v6"></path><path d="M14 11v6"></path><path d="M5 6L6 6L6 6"></path><line x1="15" y1="3" x2="9" y2="3"></line></svg>;
        const Gauge = (props) => <svg {...props} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12 14v4"></path><path d="M8.5 13.5l1 1"></path><path d="M15.5 13.5l-1 1"></path><path d="M12 2a10 10 0 1 0 10 10A10 10 0 0 0 12 2z"></path></svg>;
        const Ruler = (props) => <svg {...props} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M16 12L12 16L8 12"></path><path d="M4 4h16v16H4z"></path></svg>;
        const Shirt = (props) => <svg {...props} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M20.5 4.5l-2.5 7h-11l-2.5-7"></path><path d="M22 10l-2 10"></path><path d="M2 10l2 10"></path><path d="M12 2l4 2.5v2.5H8V4.5z"></path></svg>;
        const Camera = (props) => <svg {...props} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path><circle cx="12" cy="13" r="4"></circle></svg>;
        const ImageIcon = (props) => <svg {...props} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><polyline points="21 15 16 10 5 21"></polyline></svg>;

        // --- CONSTANTS ---
        const MAX_FILE_SIZE_BYTES = 750 * 1024; // 750KB limit

        // Helper function to generate a unique ID
        const generateId = () => Date.now().toString(36) + Math.random().toString(36).substring(2);

        // Helper function to convert a File object to a Base64 string
        const fileToBase64 = (file) => new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = () => resolve(reader.result);
            reader.onerror = (error) => reject(error);
        });

        // Helper function to calculate byte size from Base64 Data URL
        const getBase64ByteSize = (dataUrl) => {
            if (!dataUrl) return 0;
            const base64String = dataUrl.split(',')[1];
            return Math.ceil(base64String.length * 3 / 4);
        };

        const App = () => {
            const { useState, useEffect, useMemo, useRef } = React;

            const [db, setDb] = useState(null);
            const [auth, setAuth] = useState(null);
            const [userId, setUserId] = useState(null);
            const [fabrics, setFabrics] = useState([]);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(null);
            const [isUploading, setIsUploading] = useState(false);
            const [userEmail, setUserEmail] = useState('Anonymous User');

            // Refs for hidden file inputs
            const cameraInputRef = useRef(null);
            const galleryInputRef = useRef(null);

            // Form State
            const [newFabric, setNewFabric] = useState({
                name: '',
                totalLength: '',
                unit: 'meters',
                lengthRequiredPerOutfit: '',
            });
            const [newFabricImageFile, setNewFabricImageFile] = useState(null);

            // State for updating current stock
            const [updateFabricId, setUpdateFabricId] = useState(null);
            const [updateAmountUsed, setUpdateAmountUsed] = useState('');

            // ------------------------------------
            // 1. FIREBASE INITIALIZATION & ANONYMOUS AUTH
            // ------------------------------------

            useEffect(() => {
                // Ensure Firebase modules are loaded before initializing
                if (!window.FIREBASE_MODULES_LOADED) {
                    const timer = setTimeout(() => {
                        if (!window.FIREBASE_MODULES_LOADED) {
                            setError("Firebase modules failed to load.");
                            setLoading(false);
                        }
                    }, 5000); // 5 second timeout
                    return () => clearTimeout(timer);
                }

                try {
                    const { initializeApp, getFirestore, getAuth, onAuthStateChanged, signInAnonymously } = window.firebase;

                    const app = initializeApp(FIREBASE_CONFIG);
                    const firestore = getFirestore(app);
                    const firebaseAuth = getAuth(app);

                    setDb(firestore);
                    setAuth(firebaseAuth);

                    // Anonymous Sign-in for shared access without login screen
                    signInAnonymously(firebaseAuth).catch(err => {
                        console.error("Anonymous Sign-in failed:", err);
                        setError(`Authentication Failed: ${err.code}. Check Firebase Console for 'Anonymous' sign-in status.`);
                        setLoading(false);
                    });

                    // Set up Auth State Listener
                    const unsubscribeAuth = onAuthStateChanged(firebaseAuth, (user) => {
                        if (user) {
                            setUserId(user.uid);
                            // Anonymous users don't have an email, so we use their UID
                            setUserEmail(user.email || `Anon-${user.uid.substring(0, 8)}`);
                            setLoading(false);
                        } else {
                            // Should not happen after successful signInAnonymously
                            setUserId(null);
                            setLoading(false);
                        }
                    });

                    return () => unsubscribeAuth();
                } catch (e) {
                    console.error("Firebase Initialization Error:", e);
                    setError("Could not initialize Firebase. Check API keys and network connection.");
                    setLoading(false);
                }
            }, []);

            // ------------------------------------
            // 2. DATA LISTENER (FIRESTORE)
            // ------------------------------------

            useEffect(() => {
                if (!db || !userId) return;

                // Set up real-time listener for the shared collection
                try {
                    const fabricCollectionRef = collection(db, COLLECTION_PATH);
                    const q = query(fabricCollectionRef);

                    const unsubscribe = onSnapshot(q, (snapshot) => {
                        const fabricList = snapshot.docs.map(doc => {
                            const data = doc.data();
                            const currentLength = parseFloat(data.currentLength) || 0;
                            const lengthRequiredPerOutfit = parseFloat(data.lengthRequiredPerOutfit) || 1;
                            const potentialOutfits = Math.floor(currentLength / lengthRequiredPerOutfit);

                            return {
                                id: doc.id,
                                ...data,
                                currentLength,
                                lengthRequiredPerOutfit,
                                potentialOutfits
                            };
                        });
                        setFabrics(fabricList);
                    }, (err) => {
                        console.error("Firestore Listener Error:", err);
                        setError("Failed to fetch real-time data from Firestore. Check security rules.");
                    });

                    return () => unsubscribe();
                } catch (e) {
                    console.error("Firestore Query Error:", e);
                }
            }, [db, userId]);

            // ------------------------------------
            // 3. CRUD FUNCTIONS (FIRESTORE)
            // ------------------------------------

            // Handler for file selection from input
            const handleFileChange = (e) => {
                const file = e.target.files[0];
                if (file) {
                    setNewFabricImageFile(file);
                }
                e.target.value = null; // Reset input field
            };

            const handleAddFabric = async (e) => {
                e.preventDefault();
                if (!db || !userId) return;

                const { name, totalLength, unit, lengthRequiredPerOutfit } = newFabric;
                let imageUrlToStore = '';

                if (!name || !totalLength || !lengthRequiredPerOutfit) {
                    setError("Please fill in the fabric Name, Total Length, and Required Length per Outfit.");
                    return;
                }

                setIsUploading(true);
                setError(null);

                try {
                    if (newFabricImageFile) {
                        const rawDataUrl = await fileToBase64(newFabricImageFile);
                        const sizeInBytes = getBase64ByteSize(rawDataUrl);

                        if (sizeInBytes > MAX_FILE_SIZE_BYTES) {
                            setError(`Image is too large (${(sizeInBytes / 1024).toFixed(0)}KB). The limit is 750 KB.`);
                            return;
                        }
                        imageUrlToStore = rawDataUrl;
                    } else {
                        imageUrlToStore = `https://placehold.co/100x100/3b82f6/ffffff?text=${name.substring(0, 2).toUpperCase()}`;
                    }

                    const currentLengthFloat = parseFloat(totalLength);
                    const lengthRequiredPerOutfitFloat = parseFloat(lengthRequiredPerOutfit);

                    const newDoc = {
                        name,
                        totalLength: currentLengthFloat,
                        currentLength: currentLengthFloat,
                        unit,
                        lengthRequiredPerOutfit: lengthRequiredPerOutfitFloat,
                        imageUrl: imageUrlToStore,
                        updatedByEmail: userEmail,
                        updatedAt: window.firebase.serverTimestamp(),
                        createdAt: window.firebase.serverTimestamp(),
                    };

                    const fabricCollectionRef = collection(db, COLLECTION_PATH);
                    await window.firebase.setDoc(window.firebase.doc(fabricCollectionRef), newDoc);

                    setNewFabric({ name: '', totalLength: '', unit: 'meters', lengthRequiredPerOutfit: '' });
                    setNewFabricImageFile(null);
                    setError(null);
                } catch (e) {
                    console.error("Error adding document: ", e);
                    setError(`Failed to add new fabric stock: ${e.message}. Check Firestore Security Rules!`);
                } finally {
                    setIsUploading(false);
                }
            };

            const handleDeleteFabric = async (id) => {
                if (!db || !userId) return;

                try {
                    const docRef = doc(db, COLLECTION_PATH, id);
                    await deleteDoc(docRef);
                    setError(null);
                } catch (e) {
                    console.error("Error deleting document: ", e);
                    setError(`Failed to delete fabric entry: ${e.message}. Check Security Rules.`);
                }
            };

            const handleUpdateStock = async (e) => {
                e.preventDefault();
                if (!db || !userId || !updateFabricId || !updateAmountUsed) return;

                const amountUsed = parseFloat(updateAmountUsed);
                if (isNaN(amountUsed) || amountUsed <= 0) {
                    setError("Please enter a valid amount of fabric used (a positive number).");
                    return;
                }

                const fabric = fabrics.find(f => f.id === updateFabricId);
                if (!fabric) return;

                const newCurrentLength = fabric.currentLength - amountUsed;

                if (newCurrentLength < 0) {
                    setError(`Cannot use ${amountUsed} ${fabric.unit}. Only ${fabric.currentLength.toFixed(2)} ${fabric.unit} remaining.`);
                    return;
                }

                try {
                    const docRef = doc(db, COLLECTION_PATH, updateFabricId);

                    await setDoc(docRef, {
                        currentLength: newCurrentLength,
                        updatedByEmail: userEmail,
                        updatedAt: window.firebase.serverTimestamp(),
                    }, { merge: true }); // Use merge to only update specified fields

                    setUpdateFabricId(null);
                    setUpdateAmountUsed('');
                    setError(null);
                } catch (e) {
                    console.error("Error updating stock: ", e);
                    setError(`Failed to update fabric stock: ${e.message}. Check Security Rules.`);
                }
            };

            // ------------------------------------
            // 4. DERIVED STATE & UI RENDERING
            // ------------------------------------

            const totalPotentialOutfits = useMemo(() => {
                return fabrics.reduce((sum, f) => sum + f.potentialOutfits, 0);
            }, [fabrics]);

            if (loading || !userId) {
                return (
                    <div className="flex items-center justify-center min-h-screen bg-gray-50">
                        <div className="spinner mr-3"></div>
                        <div className="text-xl font-medium text-blue-500">Connecting to Shared Database...</div>
                    </div>
                );
            }

            if (error) {
                return (
                    <div className="p-8 bg-red-100 border-l-4 border-red-500 text-red-700 min-h-screen">
                        <p className="font-bold">Application Error</p>
                        <p>{error}</p>
                        <p className="mt-2 text-sm text-gray-600">Storage Mode: Shared (Firebase). Check Console for details.</p>
                    </div>
                );
            }

            // Format Firestore Timestamp for display
            const formatTimestamp = (timestamp) => {
                if (timestamp && timestamp.toDate) {
                    return timestamp.toDate().toLocaleTimeString();
                }
                return timestamp || 'N/A';
            };


            return (
                <div className="p-4 md:p-8 bg-gray-50 min-h-screen font-sans">
                    <div className="max-w-6xl mx-auto">
                        <h1 className="text-4xl font-extrabold text-gray-900 mb-2">Fabric Stock Manager</h1>
                        <p className="text-sm text-gray-500 mb-6">
                            User ID: <span className="font-mono bg-gray-200 p-1 rounded-md text-xs">{userEmail}</span>
                        </p>
                        <p className="text-sm text-green-700 mb-6 bg-green-100 p-2 rounded-lg border border-red-300 font-semibold">
                            This version is **Shared and Live**. All updates are synchronized in real-time on your Firebase project.
                        </p>

                        {/* Global Stats */}
                        <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
                            <div className="card bg-blue-500 text-white p-6 rounded-xl shadow-lg flex items-center">
                                <Gauge className="w-8 h-8 mr-4" />

                                <div>
                                    <p className="text-sm opacity-80 uppercase font-semibold">Total Fabrics</p>
                                    <p className="text-3xl font-bold">{fabrics.length}</p>
                                </div>
                            </div>
                            <div className="card bg-green-500 text-white p-6 rounded-xl shadow-lg flex items-center col-span-1 md:col-span-2">
                                <Shirt className="w-8 h-8 mr-4" />
                                <div>
                                    <p className="text-sm opacity-80 uppercase font-semibold">Total Potential Outfits Remaining</p>
                                    <p className="text-3xl font-bold">{totalPotentialOutfits}</p>
                                </div>
                            </div>
                        </div>

                        {/* Add New Fabric Section */}
                        <div className="card bg-white p-6 rounded-xl shadow-lg mb-8">
                            <h2 className="text-2xl font-semibold text-gray-800 mb-4 flex items-center"><Plus className="w-5 h-5 mr-2" /> Add New Fabric Stock</h2>
                            <form onSubmit={handleAddFabric} className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                {/* Fabric Name */}
                                <div className="form-input-group">
                                    <label className="block text-sm font-medium text-gray-700">Fabric Name</label>
                                    <input
                                        type="text"
                                        required
                                        className="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border focus:ring-blue-500 focus:border-blue-500"
                                        value={newFabric.name}
                                        onChange={(e) => setNewFabric({ ...newFabric, name: e.target.value })}
                                    />
                                </div>

                                {/* Total Length */}
                                <div className="form-input-group">
                                    <label className="block text-sm font-medium text-gray-700">Total Length in Stock</label>
                                    <div className="mt-1 flex rounded-md shadow-sm">
                                        <input
                                            type="number"
                                            step="0.01"
                                            min="0"
                                            required
                                            className="flex-1 block w-full rounded-l-md border-gray-300 p-2 border focus:ring-blue-500 focus:border-blue-500"
                                            value={newFabric.totalLength}
                                            onChange={(e) => setNewFabric({ ...newFabric, totalLength: e.target.value })}
                                        />
                                        <select
                                            className="inline-flex items-center px-3 rounded-r-md border border-l-0 border-gray-300 bg-gray-50 text-gray-500 text-sm"
                                            value={newFabric.unit}
                                            onChange={(e) => setNewFabric({ ...newFabric, unit: e.target.value })}
                                        >
                                            <option value="meters">meters</option>
                                            <option value="yards">yards</option>
                                        </select>
                                    </div>
                                </div>

                                {/* Length Required Per Outfit */}
                                <div className="form-input-group">
                                    <label className="block text-sm font-medium text-gray-700">Length Required per Outfit</label>
                                    <input
                                        type="number"
                                        step="0.01"
                                        min="0.1"
                                        required
                                        className="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border focus:ring-blue-500 focus:border-blue-500"
                                        value={newFabric.lengthRequiredPerOutfit}
                                        onChange={(e) => setNewFabric({ ...newFabric, lengthRequiredPerOutfit: e.target.value })}
                                    />
                                    <p className="mt-1 text-xs text-gray-500">How much {newFabric.unit} to make one average outfit?</p>
                                </div>

                                {/* Image Capture / Gallery Buttons */}
                                <div className="md:col-span-2 lg:col-span-3 form-input-group">
                                    <label className="block text-sm font-medium text-gray-700 mb-2">Fabric Image (Choose Option)</label>
                                    <div className="flex space-x-4">
                                        {/* Hidden input for camera */}
                                        <input
                                            type="file"
                                            accept="image/*"
                                            capture="environment"
                                            ref={cameraInputRef}
                                            onChange={handleFileChange}
                                            className="hidden"
                                        />
                                        {/* Button to trigger camera */}
                                        <button
                                            type="button"
                                            onClick={() => cameraInputRef.current.click()}
                                            className="flex flex-col items-center justify-center p-3 w-32 h-20 bg-blue-100 text-blue-800 rounded-lg shadow-md hover:bg-blue-200 transition duration-150"
                                        >
                                            <Camera className="w-6 h-6" />
                                            <span className="text-xs mt-1">Take Photo</span>
                                        </button>

                                        {/* Hidden input for gallery */}
                                        <input
                                            type="file"
                                            accept="image/*"
                                            ref={galleryInputRef}
                                            onChange={handleFileChange}
                                            className="hidden"
                                        />
                                        {/* Button to trigger gallery */}
                                        <button
                                            type="button"
                                            onClick={() => galleryInputRef.current.click()}
                                            className="flex flex-col items-center justify-center p-3 w-32 h-20 bg-indigo-100 text-indigo-800 rounded-lg shadow-md hover:bg-indigo-200 transition duration-150"
                                        >
                                            <ImageIcon className="w-6 h-6" />
                                            <span className="text-xs mt-1">Upload from Gallery</span>
                                        </button>
                                    </div>

                                    {newFabricImageFile && (
                                        <p className="mt-3 text-xs text-green-600">
                                            File selected: <span className="font-semibold">{newFabricImageFile.name}</span>
                                            {(newFabricImageFile.size / 1024).toFixed(0) > 750 ?
                                                <span className="text-red-600 font-bold ml-2"> (Too Large! Limit 750 KB)</span> : ''
                                            }
                                        </p>
                                    )}
                                    <p className="mt-1 text-xs text-gray-500">
                                        Images are stored in Firebase documents as a Base64 string (Max 750 KB).
                                    </p>
                                </div>

                                {/* Submit Button */}
                                <div className="md:col-span-2 lg:col-span-3 pt-2 form-input-group">
                                    <button
                                        type="submit"
                                        disabled={isUploading || !db}
                                        className={`w-full justify-center inline-flex items-center px-4 py-2 border border-transparent rounded-md shadow-sm text-base font-medium text-white transition duration-150 ${isUploading ? 'bg-gray-400 cursor-not-allowed' : 'bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500'}`}
                                    >
                                        {isUploading ? (
                                            <>
                                                <span className="spinner mr-2"></span> Uploading...
                                            </>
                                        ) : (
                                            <>
                                                <Plus className="w-5 h-5 mr-2" /> Add Fabric to Stock
                                            </>
                                        )}
                                    </button>
                                </div>
                            </form>
                        </div>

                        {/* Current Stock List */}
                        <h2 className="text-3xl font-bold text-gray-900 mb-6">Current Fabric Stock ({fabrics.length} items)</h2>

                        {fabrics.length === 0 ? (
                            <div className="p-8 text-center bg-white rounded-xl shadow-lg text-gray-500">No fabric stock recorded yet. Use the form above to add an item!</div>
                        ) : (
                            <div className="grid grid-cols-1 gap-6">
                                {fabrics.map((fabric) => (
                                    <div key={fabric.id} className="card bg-white p-5 rounded-xl shadow-md flex flex-col md:flex-row justify-between items-start md:items-center">
                                        <div className="flex items-center mb-4 md:mb-0 w-full md:w-3/5">
                                            {/* Image Placeholder/Display */}
                                            <img
                                                src={fabric.imageUrl}
                                                alt={fabric.name}
                                                className="w-20 h-20 object-cover rounded-lg shadow-inner mr-4 border border-gray-200"
                                                onError={(e) => {
                                                    e.target.onerror = null;
                                                    e.target.src = `https://placehold.co/80x80/ef4444/ffffff?text=Image+N/A`;
                                                }}
                                            />
                                            {/* Fabric Details */}
                                            <div>
                                                <h3 className="text-xl font-bold text-gray-900">{fabric.name}</h3>
                                                <div className="text-sm text-gray-600 space-y-1 mt-1">
                                                    <p className="flex items-center"><Ruler className="w-4 h-4 mr-2 text-blue-500" /> Stock: {fabric.currentLength.toFixed(2)} {fabric.unit}</p>
                                                    <p className="flex items-center"><Shirt className="w-4 h-4 mr-2 text-green-500" /> Req. per Outfit: {fabric.lengthRequiredPerOutfit.toFixed(2)} {fabric.unit}</p>
                                                </div>
                                                <p className="text-xs text-gray-400 mt-2">
                                                    Last updated by:
                                                    <span className="font-semibold text-gray-600 ml-1">{fabric.updatedByEmail || 'Local User'}</span>
                                                    <span className="ml-2">({formatTimestamp(fabric.updatedAt) || 'N/A'})</span>
                                                </p>
                                            </div>
                                        </div>

                                        {/* Stock & Calculation */}
                                        <div className="w-full md:w-2/5 flex flex-col space-y-3">
                                            <div className="flex justify-between items-center bg-gray-100 p-3 rounded-lg">
                                                <div>
                                                    <p className="text-sm font-medium text-gray-500">Remaining Stock</p>
                                                    <p className="text-2xl font-extrabold text-blue-600">
                                                        {fabric.currentLength.toFixed(2)} {fabric.unit}
                                                    </p>
                                                </div>
                                                <div>
                                                    <p className="text-sm font-medium text-gray-500">Potential Outfits</p>
                                                    <p className="text-2xl font-extrabold text-green-600">
                                                        {fabric.potentialOutfits}
                                                    </p>
                                                </div>
                                            </div>

                                            {/* Stock Update Form / Delete Button */}
                                            {updateFabricId === fabric.id ? (
                                                <form onSubmit={handleUpdateStock} className="flex space-x-2">
                                                    <input
                                                        type="number"
                                                        step="0.01"
                                                        min="0.01"
                                                        required
                                                        placeholder={`Amount used (${fabric.unit})`}
                                                        className="flex-1 p-2 border border-yellow-300 rounded-md shadow-sm focus:ring-yellow-500 focus:border-yellow-500"
                                                        value={updateAmountUsed}
                                                        onChange={(e) => setUpdateAmountUsed(e.target.value)}
                                                    />
                                                    <button
                                                        type="submit"
                                                        className="bg-yellow-500 text-gray-900 px-4 py-2 rounded-md font-medium hover:bg-yellow-600 transition duration-150"
                                                    >
                                                        Use
                                                    </button>
                                                    <button
                                                        type="button"
                                                        onClick={() => { setUpdateFabricId(null); setUpdateAmountUsed(''); }}
                                                        className="bg-gray-300 text-gray-800 px-3 py-2 rounded-md font-medium hover:bg-gray-400 transition duration-150"
                                                    >
                                                        Cancel
                                                    </button>
                                                </form>
                                            ) : (
                                                <div className="flex space-x-2">
                                                    <button
                                                        onClick={() => setUpdateFabricId(fabric.id)}
                                                        className="flex-1 bg-yellow-400 text-gray-900 px-4 py-2 rounded-md font-medium hover:bg-yellow-500 transition duration-150 shadow-md"
                                                    >
                                                        Update Stock (Use Material)
                                                    </button>
                                                    <button
                                                        onClick={() => handleDeleteFabric(fabric.id)}
                                                        className="p-3 bg-red-100 text-red-600 rounded-md hover:bg-red-200 transition duration-150"
                                                        title="Delete Fabric Entry"
                                                    >
                                                        <Trash2 className="w-5 h-5" />
                                                    </button>
                                                </div>
                                            )}
                                        </div>
                                    </div>
                                ))}
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        // Render the App
        const container = document.getElementById('root');
        // Use React 18's createRoot API
        const root = ReactDOM.createRoot(container);
        root.render(<App />);
    </script>
</body>

</html>