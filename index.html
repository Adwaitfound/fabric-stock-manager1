<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Poshakh Fabric Stock Manager</title>
    <!-- REMOVED EXTERNAL TAILWIND SCRIPT -->
    <style>
        /* BASE STYLES & FONTS */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&display=swap');

        body {
            font-family: 'Inter', sans-serif;
            background-color: #F5F5DC;
            /* Updated: Clean Beige/Cream Background */
            min-height: 100vh;
            padding: 1rem;
        }

        /* --- UI UTILITY CLASSES (Hardcoded CSS) --- */
        .max-w-6xl {
            max-width: 72rem;
        }

        .mx-auto {
            margin-left: auto;
            margin-right: auto;
        }

        .p-4 {
            padding: 1rem;
        }

        .md\:p-8 {
            padding: 2rem;
        }

        .min-h-screen {
            min-height: 100vh;
        }

        .bg-gray-50 {
            background-color: #F5F5DC;
        }

        /* Updated: Use new background color */
        .font-sans {
            font-family: 'Inter', sans-serif;
        }

        .mb-2 {
            margin-bottom: 0.5rem;
        }

        .mb-4 {
            margin-bottom: 1rem;
        }

        .mb-6 {
            margin-bottom: 1.5rem;
        }

        .mb-8 {
            margin-bottom: 2rem;
        }

        .mt-1 {
            margin-top: 0.25rem;
        }

        .mt-2 {
            margin-top: 0.5rem;
        }

        .mt-3 {
            margin-top: 0.75rem;
        }

        .mr-2 {
            margin-right: 0.5rem;
        }

        .mr-3 {
            margin-right: 0.75rem;
        }

        .mr-4 {
            margin-right: 1rem;
        }

        .ml-1 {
            margin-left: 0.25rem;
        }

        .ml-2 {
            margin-left: 0.5rem;
        }

        .ml-4 {
            margin-left: 1rem;
        }

        .space-x-2>*+* {
            margin-left: 0.5rem;
        }

        .space-x-4>*+* {
            margin-left: 1rem;
        }

        .space-y-1>*+* {
            margin-top: 0.25rem;
        }

        .space-y-3>*+* {
            margin-top: 0.75rem;
        }

        .pt-2 {
            padding-top: 0.5rem;
        }

        .px-3 {
            padding-left: 0.75rem;
            padding-right: 0.75rem;
        }

        .px-4 {
            padding-left: 1rem;
            padding-right: 1rem;
        }

        .py-2 {
            padding-top: 0.5rem;
            padding-bottom: 0.5rem;
        }

        .p-1 {
            padding: 0.25rem;
        }

        .p-2 {
            padding: 0.5rem;
        }

        .p-3 {
            padding: 0.75rem;
        }

        .p-5 {
            padding: 1.25rem;
        }

        .p-6 {
            padding: 1.5rem;
        }

        .p-8 {
            padding: 2rem;
        }

        .text-center {
            text-align: center;
        }

        /* LAYOUT AND DISPLAY */
        .flex {
            display: flex;
        }

        .hidden {
            display: none;
        }

        .items-center {
            align-items: center;
        }

        .justify-center {
            justify-content: center;
        }

        .justify-between {
            justify-content: space-between;
        }

        .flex-col {
            flex-direction: column;
        }

        .flex-1 {
            flex: 1 1 0%;
        }

        .block {
            display: block;
        }

        .inline-flex {
            display: inline-flex;
        }

        .grid {
            display: grid;
        }

        .gap-4 {
            gap: 1rem;
        }

        .gap-6 {
            gap: 1.5rem;
        }

        .rounded-md {
            border-radius: 0.375rem;
        }

        .rounded-lg {
            border-radius: 0.5rem;
        }

        .rounded-xl {
            border-radius: 0.75rem;
        }

        .rounded-full {
            border-radius: 9999px;
        }

        .rounded-l-md {
            border-top-left-radius: 0.375rem;
            border-bottom-left-radius: 0.375rem;
        }

        .rounded-r-md {
            border-top-right-radius: 0.375rem;
            border-bottom-right-radius: 0.375rem;
        }

        .w-full {
            width: 100%;
        }

        .w-5 {
            width: 1.25rem;
        }

        .w-6 {
            width: 1.5rem;
        }

        .w-8 {
            width: 2rem;
        }

        .w-20 {
            width: 5rem;
        }

        .h-4 {
            height: 1rem;
        }

        .h-5 {
            height: 1.25rem;
        }

        .h-6 {
            height: 1.5rem;
        }

        .h-8 {
            height: 2rem;
        }

        .h-20 {
            height: 5rem;
        }

        .shadow-sm {
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        }

        /* Adjusted shadow for better modern look */
        .shadow-md {
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
        }

        .shadow-lg {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
        }

        .shadow-inner {
            box-shadow: inset 0 2px 4px 0 rgba(0, 0, 0, 0.06);
        }

        .object-cover {
            object-fit: cover;
        }

        .border {
            border-width: 1px;
        }

        .border-l-4 {
            border-left-width: 4px;
        }

        .border-l-0 {
            border-left-width: 0px;
        }

        .border-gray-200 {
            border-color: #e5e7eb;
        }

        .border-gray-300 {
            border-color: #d1d5db;
        }

        .border-red-300 {
            border-color: #fca5a5;
        }

        .border-yellow-300 {
            border-color: #fcd34d;
        }

        .border-transparent {
            border-color: transparent;
        }

        .card {
            transition: all 0.2s ease-in-out;
            border: 1px solid #e9ecef;
        }

        /* Subtle border for card */
        .card:hover {
            transform: translateY(-1px);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.08);
        }

        /* --- BACKGROUND IMAGE UTILITIES --- */
        .relative {
            position: relative;
        }

        .absolute {
            position: absolute;
        }

        .inset-0 {
            top: 0;
            right: 0;
            bottom: 0;
            left: 0;
        }

        .bg-cover {
            background-size: cover;
        }

        .bg-center {
            background-position: center;
        }

        .opacity-10 {
            opacity: 0.10;
        }

        .opacity-25 {
            opacity: 0.25;
        }

        .opacity-90 {
            opacity: 0.90;
        }


        /* TEXT AND COLORS (Poshakh Palette: Ruby Red/Maroon and Gold/Mustard) */
        .text-xs {
            font-size: 0.75rem;
        }

        .text-sm {
            font-size: 0.875rem;
        }

        .text-base {
            font-size: 1rem;
        }

        .text-xl {
            font-size: 1.25rem;
        }

        .text-2xl {
            font-size: 1.5rem;
        }

        .text-3xl {
            font-size: 1.875rem;
        }

        .text-4xl {
            font-size: 2.25rem;
        }

        .text-gray-900 {
            color: #111827;
        }

        .text-gray-800 {
            color: #1f2937;
        }

        .text-gray-700 {
            color: #374151;
        }

        .text-gray-600 {
            color: #4b5563;
        }

        .text-gray-500 {
            color: #6c757d;
        }

        /* Darker gray for better contrast */
        .text-gray-400 {
            color: #9ca3af;
        }

        /* RUBY RED / MAROON - PRIMARY BRAND COLOR */
        .text-ruby-red {
            color: #880000;
        }

        /* Deep Ruby Red */
        .bg-ruby-red-100 {
            background-color: #ffeaea;
        }

        /* Very light red */
        .bg-ruby-red-800 {
            color: #880000;
        }

        .text-dark-red {
            color: #B40000;
        }

        /* LIGHT GOLD / AMBER - ACCENT COLOR */
        .text-light-gold {
            color: #B47C00;
        }

        /* Adjusted Gold */
        .bg-light-gold-100 {
            background-color: #fff8e1;
        }

        /* DEEP GREEN - NEW STANDARD COLOR */
        .bg-standard-green {
            background-color: #006400;
        }

        /* Darker Green for professionalism */
        .text-standard-green {
            color: #006400;
        }

        /* DARK GRAY/BLUE - HIGH CONTRAST */
        .bg-dark-contrast {
            background-color: #334155;
        }

        /* NEW: For Total Inventory Value contrast */

        /* ACCENT COLORS */
        .text-gold-600 {
            color: #D97706;
        }

        .bg-gold-100 {
            background-color: #fff9e6;
        }

        .bg-gold-500 {
            background-color: #f59e0b;
        }

        .text-blue-500 {
            color: #4361ee;
        }

        .text-white {
            color: #ffffff;
        }

        /* SUCCESS & WARNING COLORS */
        .text-green-600 {
            color: #059669;
        }

        .bg-green-100 {
            background-color: #d1fae5;
        }

        .bg-red-100 {
            background-color: #fee2e2;
        }

        .bg-red-500 {
            border-color: #ef4444;
        }

        .text-red-600 {
            color: #ef4444;
        }

        /* Global Stats Theme Colors (Standard Green + White Text) */
        .bg-metric {
            background-color: #006400;
        }

        /* Deep Green */
        .text-metric {
            color: #ffffff;
        }

        .icon-metric {
            color: #ffffff;
            opacity: 0.8;
        }


        /* NEUTRAL BACKGROUNDS */
        /* Using standard white for better contrast */
        .bg-white {
            background-color: #ffffff;
        }

        .bg-gray-100 {
            background-color: #f8f9fa;
        }

        .bg-gray-200 {
            background-color: #e9ecef;
        }

        .bg-gray-300 {
            background-color: #d1d5db;
        }


        .font-bold {
            font-weight: 700;
        }

        .font-extrabold {
            font-weight: 800;
        }

        .font-medium {
            font-weight: 500;
        }

        .font-semibold {
            font-weight: 600;
        }

        .font-mono {
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
        }

        .opacity-80 {
            opacity: 0.8;
        }

        .uppercase {
            text-transform: uppercase;
        }

        .z-10 {
            z-index: 10;
        }

        /* For layering over background image */

        /* NEW TAB STYLES */
        .tab-button {
            padding: 0.75rem 1.5rem;
            font-weight: 600;
            border-radius: 0.5rem 0.5rem 0 0;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.2s ease-in-out;
        }

        .tab-active {
            color: #880000;
            /* Ruby Red */
            background-color: #ffffff;
            border-bottom-color: #880000;
        }

        .tab-inactive {
            color: #4b5563;
            /* Gray-600 */
            background-color: #e9ecef;
            border-bottom-color: #d1d5db;
        }


        /* INTERACTION & FORM */
        .cursor-not-allowed {
            cursor: not-allowed;
        }

        .focus\:ring-ruby-red:focus {
            --tw-ring-color: #880000;
            ring-width: 2px;
        }

        .focus\:border-ruby-red:focus {
            border-color: #880000;
        }

        /* Button Colors (Updated to Ruby Red and Gold) */
        .btn-primary {
            background-color: #880000;
            color: white;
        }

        /* Ruby Red Primary */
        .btn-primary:hover {
            background-color: #6a0000;
        }

        .btn-secondary {
            background-color: #D97706;
            color: white;
        }

        /* Gold Secondary */
        .btn-secondary:hover {
            background-color: #f59e0b;
        }

        /* Form Focus */
        .form-input-group input:focus,
        .form-input-group select:focus {
            border-color: #880000;
            box-shadow: 0 0 0 1px #880000;
            outline: none;
        }


        /* LOADING */
        .loading-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #880000;
            /* Ruby Red spinner */
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* NEW MODAL STYLES */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            /* High z-index */
        }

        .modal-content {
            max-width: 90%;
            max-height: 90%;
            position: relative;
        }

        .modal-close-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            border-radius: 50%;
            padding: 10px;
            cursor: pointer;
            font-size: 20px;
            line-height: 1;
            z-index: 1001;
        }


        /* RESPONSIVENESS */
        @media (min-width: 768px) {
            .md\:p-8 {
                padding: 2rem;
            }

            .md\:flex-row {
                flex-direction: row;
            }

            .md\:items-center {
                align-items: center;
            }

            .md\:mb-0 {
                margin-bottom: 0;
            }

            .md\:w-3\/5 {
                width: 60%;
            }

            .md\:w-2\/5 {
                width: 40%;
            }

            .md\:grid-cols-2 {
                grid-template-columns: repeat(2, minmax(0, 1fr));
            }

            .lg\:grid-cols-3 {
                grid-template-columns: repeat(3, minmax(0, 1fr));
            }

            .lg\:grid-cols-4 {
                grid-template-columns: repeat(4, minmax(0, 1fr));
            }

            /* Added 4-column grid */
            .col-span-1 {
                grid-column: span 1 / span 1;
            }

            .col-span-2 {
                grid-column: span 2 / span 2;
            }

            .col-span-3 {
                grid-column: span 3 / span 3;
            }

            .col-span-4 {
                grid-column: span 4 / span 4;
            }
        }
    </style>
</head>

<body>
    <div id="root">
        <div className="loading-container">
            <div className="spinner mr-3"></div>
            <div className="text-xl font-medium text-blue-500">Loading Application...</div>
        </div>
    </div>

    <!-- ---------------------------------------------------- -->
    <!-- FIREBASE AND REACT SCRIPTS -->
    <!-- ---------------------------------------------------- -->

    <!-- Firebase SDKs are loaded from CDN for Auth and Firestore -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, doc, setDoc, deleteDoc, query, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Expose Firebase modules to the global window object for the Babel script to use
        window.firebase = {
            initializeApp, getAuth, signInAnonymously, onAuthStateChanged,
            getFirestore, collection, onSnapshot, doc, setDoc, deleteDoc, query, addDoc, serverTimestamp
        };
        window.FIREBASE_MODULES_LOADED = true;
    </script>

    <!-- React and Babel for JSX in browser -->
    <script src="https://unpkg.com/react@18.2.0/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18.2.0/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script type="text/babel">
        // ----------------------------------------------------
        // FIREBASE CONFIGURATION (INJECTED)
        // ----------------------------------------------------
        const FIREBASE_CONFIG = {
            // UPDATED KEYS FOR NEW PROJECT: poshakh-fabric-final
            apiKey: "AIzaSyA-iTofFK-Y1QZtmVs-yzpEWiEzyfBHuu4",
            authDomain: "poshakh-fabric-final.firebaseapp.com",
            projectId: "poshakh-fabric-final",
            storageBucket: "poshakh-fabric-final.firebasestorage.app",
            messagingSenderId: "3725988553447",
            appId: "1:372598853447:web:5d177d6bdc5066c02c0662"
        };

        // --- Firestore Collection Path ---
        // Shared public path for all teams accessing the app
        const COLLECTION_PATH = 'artifacts/poshakh-fabric-manager/public/data/fabrics';
        const APP_ID = 'poshakh-fabric-manager'; // Used for the artifacts path

        // --- GOOGLE SHEET WEBHOOK URL ---
        // PASTE YOUR DEPLOYED GOOGLE APPS SCRIPT URL HERE
        const GOOGLE_SHEET_WEBHOOK_URL = 'https://script.google.com/macros/s/AKfycbxxBvbO646zFs-jU5XVnuni-5Ko6tiqmZCef44vqsvp5qirq-QglzADs_PVjd6oHhe3/exec';

        const ORDER_PREFIX = '#PoshkahFC-';


        // Icons (simplified from lucide-react for single-file HTML)
        const Plus = (props) => <svg {...props} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>;
        const Trash2 = (props) => <svg {...props} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6"></path><path d="M10 11v6"></path><path d="M14 11v6"></path><path d="M5 6L6 6L6 6"></path><line x1="15" y1="3" x2="9" y2="3"></line></svg>;
        const Gauge = (props) => <svg {...props} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12 14v4"></path><path d="M8.5 13.5l1 1"></path><path d="M15.5 13.5l-1 1"></path><path d="M12 2a10 10 0 1 0 10 10A10 10 0 0 0 12 2z"></path></svg>;
        const Ruler = (props) => <svg {...props} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M16 12L12 16L8 12"></path><path d="M4 4h16v16H4z"></path></svg>;
        const Shirt = (props) => <svg {...props} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M20.5 4.5l-2.5 7h-11l-2.5-7"></path><path d="M22 10l-2 10"></path><path d="M2 10l2 10"></path><path d="M12 2l4 2.5v2.5H8V4.5z"></path></svg>;
        const Camera = (props) => <svg {...props} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path><circle cx="12" cy="13" r="4"></circle></svg>;
        const ImageIcon = (props) => <svg {...props} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><polyline points="21 15 16 10 5 21"></polyline></svg>;
        const Tag = (props) => <svg {...props} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M20.5 4.5l-2.5 7h-11l-2.5-7"></path><path d="M22 10l-2 10"></path><path d="M2 10l2 10"></path><path d="M12 2l4 2.5v2.5H8V4.5z"></path></svg>;
        const Hash = (props) => <svg {...props} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="4" y1="9" x2="20" y2="9"></line><line x1="4" y1="15" x2="20" y2="15"></line><line x1="10" y1="3" x2="8" y2="21"></line><line x1="16" y1="3" x2="14" y2="21"></line></svg>;
        const User = (props) => <svg {...props} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>;
        const Scissors = (props) => <svg {...props} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="6" cy="6" r="3"></circle><circle cx="6" cy="18" r="3"></circle><line x1="20" y1="4" x2="8.12" y2="15.88"></line><line x1="14.47" y1="14.48" x2="20" y2="20"></line><line x1="8.12" y1="8.12" x2="12" y2="12"></line></svg>;
        const Clock = (props) => <svg {...props} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>;
        const CheckCircle = (props) => <svg {...props} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>; // New Icon
        const ShoppingCart = (props) => <svg {...props} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="9" cy="21" r="1"></circle><circle cx="20" cy="21" r="1"></circle><path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"></path></svg>; // New Icon
        const Layers = (props) => <svg {...props} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12 2l10 5.5-10 5.5-10-5.5zm0 18l10-5.5-10-5.5-10 5.5z"></path></svg>; // New Icon
        const ChevronRight = (props) => <svg {...props} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="9 18 15 12 9 6"></polyline></svg>;
        const ChevronDown = (props) => <svg {...props} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg>;
        const X = (props) => <svg {...props} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>;
        const ListOrdered = (props) => <svg {...props} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="10" y1="6" x2="21" y2="6"></line><line x1="10" y1="12" x2="21" y2="12"></line><line x1="10" y1="18" x2="21" y2="18"></line><path d="M4 6h1"></path><path d="M3 12h2"></path><path d="M4 18h1"></path></svg>;
        const DollarSign = (props) => <svg {...props} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="12" y1="1" x2="12" y2="23"></line><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path></svg>;


        // --- CONSTANTS ---
        const MAX_FILE_SIZE_BYTES = 750 * 1024; // 750KB limit
        const AVERAGE_SELLING_PRICE = 1500; // INR, based on poshakhfabrics.com average price of ~₹1,500
        const RUPEE_ICON = '₹'; // Indian Rupee Symbol

        // Helper function to generate a unique ID
        const generateId = () => Date.now().toString(36) + Math.random().toString(36).substring(2);

        // Helper function to convert a File object to a Base64 string
        const fileToBase64 = (file) => new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = () => resolve(reader.result);
            reader.onerror = (error) => reject(error);
        });

        // Helper function to calculate byte size from Base64 Data URL
        const getBase64ByteSize = (dataUrl) => {
            if (!dataUrl) return 0;
            const base64String = dataUrl.split(',')[1];
            return Math.ceil(base64String.length * 3 / 4);
        };

        /**
         * Sends data to the Google Apps Script Webhook.
         * Runs in the background and does not block the main app flow.
         */
        const pushToGoogleSheet = async (payload) => {
            if (!GOOGLE_SHEET_WEBHOOK_URL) {
                console.warn("Skipping Google Sheet update: GOOGLE_SHEET_WEBHOOK_URL is not set.");
                return;
            }
            try {
                const response = await fetch(GOOGLE_SHEET_WEBHOOK_URL, {
                    method: 'POST',
                    mode: 'no-cors', // Important for GAS webhooks to avoid CORS issues
                    cache: 'no-cache',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                // Note: Due to 'no-cors' mode, we often cannot read the response status directly,
                // but a successful fetch indicates the data was sent.
                console.log('Data sent to Google Sheet webhook.');
            } catch (error) {
                console.error("Failed to push data to Google Sheet:", error);
            }
        };


        const App = () => {
            const { useState, useEffect, useMemo, useRef } = React;
            const { initializeApp, getAuth, signInAnonymously, onAuthStateChanged, getFirestore, collection, onSnapshot, doc, setDoc, deleteDoc, query, addDoc, serverTimestamp } = window.firebase;


            const [db, setDb] = useState(null);
            const [auth, setAuth] = useState(null);
            const [userId, setUserId] = useState(null);
            const [fabrics, setFabrics] = useState([]);
            const [loading, setLoading] = useState(true);
            const [fatalError, setFatalError] = useState(null); // For connection/auth failures
            const [operationalError, setOperationalError] = useState(null); // For form/CRUD failures
            const [isUploading, setIsUploading] = useState(false);
            const [userEmail, setUserEmail] = useState('Anon-User');

            // NEW STATE FOR IMAGE MODAL
            const [selectedImageUrl, setSelectedImageUrl] = useState(null);


            // NEW STATE FOR TABS
            const [activeTab, setActiveTab] = useState('orders'); // Default to Order Assignment

            // Refs for hidden file inputs
            const cameraInputRef = useRef(null);
            const galleryInputRef = useRef(null);


            // Form State (Stock Addition)
            const [newFabric, setNewFabric] = useState({
                name: '',
                websiteProductName: '',
                totalLength: '',
                unit: 'meters',
                lengthRequiredPerOutfit: '',
                costPerMeter: '',
            });
            const [newFabricImageFile, setNewFabricImageFile] = useState(null);

            // Form State (Order Assignment)
            const [orderForm, setOrderForm] = useState({
                orderNumber: '',
                fabricId: '',
                lengthToCut: '',
                customerName: '',
                outputStyle: '',
                size: 'M',
            });

            // State for updating current stock
            const [isStockAdjusting, setIsStockAdjusting] = useState(false); // Modal visibility
            const [adjustmentType, setAdjustmentType] = useState(null); // 'ADD' or 'DEDUCT'
            const [adjustmentFabricId, setAdjustmentFabricId] = useState(null); // Fabric ID for modal
            const [adjustmentAmount, setAdjustmentAmount] = useState(''); // Amount input for modal

            // State for viewing history
            const [historyFabricId, setHistoryFabricId] = useState(null);
            const [transactionHistory, setTransactionHistory] = useState([]);
            const [expandedTransactionId, setExpandedTransactionId] = useState(null);

            // State for receiving order (required selling price)
            const [sellingPrice, setSellingPrice] = useState('');


            // Dynamic value for Order Form based on selected fabric
            const selectedFabric = useMemo(() => {
                // Ensure fabrics is an array before trying to find
                if (!Array.isArray(fabrics)) return null;
                return fabrics.find(f => f.id === orderForm.fabricId);
            }, [fabrics, orderForm.fabricId]);

            // Filtered & Sorted list for Order History Tab
            const orderedFabricsSorted = useMemo(() => {
                // Safely ensure fabrics is an array
                if (!Array.isArray(fabrics)) return [];

                return fabrics
                    .filter(f => f.lastOrderNumber)
                    .sort((a, b) => {
                        // Sort by order number string alphabetically
                        const orderA = a.lastOrderNumber.toUpperCase();
                        const orderB = b.lastOrderNumber.toUpperCase();
                        if (orderA < orderB) return -1;
                        if (orderA > orderB) return 1;

                        // Secondary sort by date (newest first)
                        const timeA = a.updatedAt ? (a.updatedAt.toMillis ? a.updatedAt.toMillis() : Date.parse(a.updatedAt)) : 0;
                        const timeB = b.updatedAt ? (b.updatedAt.toMillis ? b.updatedAt.toMillis() : Date.parse(b.updatedAt)) : 0;
                        return timeB - timeA;
                    });
            }, [fabrics]);

            // --- NEW FINANCIAL METRICS ---
            const financialMetrics = useMemo(() => {
                if (!Array.isArray(fabrics)) {
                    return {
                        totalLengthMeters: 0,
                        totalPotentialRevenue: 0,
                        mostUsed: { name: 'N/A', cut: 0 },
                        leastUsed: { name: 'N/A', cut: 0 },
                        mostProfitable: { name: 'N/A', margin: -Infinity },
                        leastProfitable: { name: 'N/A', margin: Infinity },
                    };
                }

                // Aggregate usage (Placeholder: Actual usage history would require fetching transaction subcollections)
                // For simplicity, we calculate "used" as (initial total length - current remaining length)
                const usageMap = new Map();

                // Track profitability margin (Potential Revenue - Cost of remaining stock)
                const profitabilityMap = [];

                let totalLengthMeters = 0;
                let totalPotentialRevenue = 0;

                for (const fabric of fabrics) {
                    // Convert all to meters for standardizing length calculation
                    const currentLengthMeters = fabric.currentLength * (fabric.unit === 'yards' ? 0.9144 : 1);
                    const totalLengthInitialMeters = fabric.totalLength * (fabric.unit === 'yards' ? 0.9144 : 1);
                    const costPerMeter = fabric.costPerMeter / (fabric.unit === 'yards' ? 0.9144 : 1);

                    const lengthRequiredMeters = fabric.lengthRequiredPerOutfit * (fabric.unit === 'yards' ? 0.9144 : 1);

                    totalLengthMeters += currentLengthMeters;

                    // 1. Calculate Usage
                    const totalCutLength = Math.max(0, totalLengthInitialMeters - currentLengthMeters);
                    usageMap.set(fabric.id, { name: fabric.name, cut: totalCutLength });

                    // 2. Calculate Potential Profitability
                    const potentialOutfits = fabric.potentialOutfits;
                    const potentialRevenueRemaining = potentialOutfits * AVERAGE_SELLING_PRICE;
                    const currentStockCost = currentLengthMeters * costPerMeter;

                    const estimatedGrossMargin = potentialRevenueRemaining - currentStockCost;

                    profitabilityMap.push({
                        id: fabric.id,
                        name: fabric.name,
                        margin: estimatedGrossMargin,
                    });

                    totalPotentialRevenue += potentialRevenueRemaining;
                }

                // Find Most/Least Used
                const usageArray = Array.from(usageMap.values()).filter(u => u.cut > 0);
                const mostUsed = usageArray.reduce((prev, curr) => (curr.cut > prev.cut ? curr : prev), { name: 'N/A', cut: 0 });
                const leastUsed = usageArray.reduce((prev, curr) => (curr.cut < prev.cut ? curr : prev), { name: 'N/A', cut: Infinity });

                // Find Most/Least Profitable
                const mostProfitable = profitabilityMap.reduce((prev, curr) => (curr.margin > prev.margin ? curr : prev), { name: 'N/A', margin: -Infinity });
                const leastProfitable = profitabilityMap.reduce((prev, curr) => (curr.margin < prev.margin ? curr : prev), { name: 'N/A', margin: Infinity });


                return {
                    totalLengthMeters: totalLengthMeters.toFixed(2),
                    totalPotentialRevenue: totalPotentialRevenue.toFixed(2),
                    mostUsed,
                    leastUsed: leastUsed.cut === Infinity ? { name: 'N/A', cut: 0 } : leastUsed,
                    mostProfitable,
                    leastProfitable: leastProfitable.margin === Infinity ? { name: 'N/A', margin: 0 } : leastProfitable,
                };
            }, [fabrics]);

            // ------------------------------------
            // 1. FIREBASE INITIALIZATION & ANONYMOUS AUTH
            // ------------------------------------

            useEffect(() => {
                if (!window.FIREBASE_MODULES_LOADED) {
                    const timer = setTimeout(() => {
                        if (!window.FIREBASE_MODULES_LOADED) {
                            setFatalError("Firebase modules failed to load.");
                            setLoading(false);
                        }
                    }, 5000);
                    return () => clearTimeout(timer);
                }

                try {
                    const app = initializeApp(FIREBASE_CONFIG);
                    const firestore = getFirestore(app);
                    const firebaseAuth = getAuth(app);

                    setDb(firestore);
                    setAuth(firebaseAuth);

                    signInAnonymously(firebaseAuth).catch(err => {
                        console.error("Anonymous Sign-in failed:", err);
                        setFatalError(`Authentication Failed: ${err.code}. Check Firebase Console for 'Anonymous' sign-in status.`);
                        setLoading(false);
                    });

                    const unsubscribeAuth = onAuthStateChanged(firebaseAuth, (user) => {
                        if (user) {
                            setUserId(user.uid);
                            setUserEmail(user.email || `Anon-${user.uid.substring(0, 8)}`);
                            setLoading(false);
                        } else {
                            setUserId(null);
                            setLoading(false);
                        }
                    });

                    return () => unsubscribeAuth();
                } catch (e) {
                    console.error("Firebase Initialization Error:", e);
                    setFatalError("Could not initialize Firebase. Check API keys and network connection.");
                    setLoading(false);
                }
            }, [initializeApp, getAuth, signInAnonymously, getFirestore, onAuthStateChanged]);


            // ------------------------------------
            // 2. DATA LISTENER (FIRESTORE)
            // ------------------------------------

            useEffect(() => {
                if (!db || !userId) return;

                try {
                    const fabricCollectionRef = collection(db, COLLECTION_PATH);
                    const q = query(fabricCollectionRef);

                    const unsubscribe = onSnapshot(q, (snapshot) => {
                        const fabricList = snapshot.docs.map(doc => {
                            const data = doc.data();
                            const currentLength = parseFloat(data.currentLength) || 0;
                            const lengthRequiredPerOutfit = parseFloat(data.lengthRequiredPerOutfit) || 1;
                            const costPerMeter = parseFloat(data.costPerMeter) || 0;

                            const potentialOutfits = Math.floor(currentLength / lengthRequiredPerOutfit);
                            const totalCurrentCost = currentLength * costPerMeter;

                            return {
                                id: doc.id,
                                ...data,
                                currentLength,
                                lengthRequiredPerOutfit,
                                costPerMeter,
                                potentialOutfits,
                                totalCurrentCost,
                                // Need to store totalLength as initial length for usage calculation later
                                totalLength: parseFloat(data.totalLength) || 0,
                            };
                        });
                        setFabrics(fabricList);
                    }, (err) => {
                        console.error("Firestore Listener Error:", err);
                        setOperationalError("Failed to fetch real-time data from Firestore. Check security rules.");
                    });

                    return () => unsubscribe();
                } catch (e) {
                    console.error("Firestore Query Error:", e);
                }
            }, [db, userId, collection, onSnapshot, query]);

            // ------------------------------------
            // 3. TRANSACTION HISTORY LISTENER
            // ------------------------------------
            useEffect(() => {
                if (!db || !userId || !historyFabricId) {
                    setTransactionHistory([]);
                    return;
                }

                try {
                    const fabricDocRef = doc(collection(db, COLLECTION_PATH), historyFabricId);
                    const historyCollectionRef = collection(fabricDocRef, 'history');
                    const q = query(historyCollectionRef);

                    const unsubscribeHistory = onSnapshot(q, (snapshot) => {
                        const historyList = snapshot.docs.map(doc => ({
                            id: doc.id,
                            ...doc.data()
                        })).sort((a, b) => {
                            const timeA = a.usedAt ? (a.usedAt.toMillis ? a.usedAt.toMillis() : Date.parse(a.usedAt)) : 0;
                            const timeB = b.usedAt ? (b.usedAt.toMillis ? b.usedAt.toMillis() : Date.parse(b.usedAt)) : 0;
                            return timeB - timeA;
                        });

                        setTransactionHistory(historyList);
                    }, (err) => {
                        console.error("History Listener Error:", err);
                        setOperationalError(`Failed to load history for ${historyFabricId}.`);
                    });

                    return () => unsubscribeHistory();
                } catch (e) {
                    console.error("History Query Error:", e);
                }
            }, [db, userId, historyFabricId, collection, doc, onSnapshot, query]);


            // ------------------------------------
            // 4. CRUD FUNCTIONS (FIRESTORE)
            // ------------------------------------

            // Handler for file selection from input
            const handleFileChange = (e, targetFileStateSetter) => {
                const file = e.target.files[0];
                if (file) {
                    targetFileStateSetter(file);
                }
                e.target.value = null; // Reset input field
            };

            const resetFormAndState = () => {
                setNewFabric({ name: '', websiteProductName: '', totalLength: '', unit: 'meters', lengthRequiredPerOutfit: '', costPerMeter: '' });
                setNewFabricImageFile(null);
                setOperationalError(null);
            }

            const handleAddFabricWrapper = async (e) => {
                e.preventDefault();
                setOperationalError(null);
                setIsUploading(true);

                try {
                    await handleAddFabric(e);
                } catch (error) {
                    console.error("Critical error in add fabric wrapper:", error);
                } finally {
                    setTimeout(() => setIsUploading(false), 200);
                }
            }


            const handleAddFabric = async () => {
                if (!db || !userId) throw new Error("Database not initialized.");

                const { name, websiteProductName, totalLength, unit, lengthRequiredPerOutfit, costPerMeter } = newFabric;
                let imageUrlToStore = '';

                if (!name || !totalLength || !lengthRequiredPerOutfit || !costPerMeter) {
                    setOperationalError("Please fill in ALL required fields (Fabric Name, Length, Required Length, and Cost per Meter).");
                    return;
                }

                try {
                    if (newFabricImageFile) {
                        const rawDataUrl = await fileToBase64(newFabricImageFile);
                        const sizeInBytes = getBase64ByteSize(rawDataUrl);

                        if (sizeInBytes > MAX_FILE_SIZE_BYTES) {
                            setOperationalError(`Image is too large (${(sizeInBytes / 1024).toFixed(0)}KB). The limit is 750 KB.`);
                            return;
                        }
                        imageUrlToStore = rawDataUrl;
                    } else {
                        const placeholderText = name.substring(0, 2).toUpperCase() || 'FAB';
                        imageUrlToStore = `https://placehold.co/80x80/880000/ffffff?text=${placeholderText}`;
                    }

                    const currentLengthFloat = parseFloat(totalLength) || 0;
                    const lengthRequiredPerOutfitFloat = parseFloat(lengthRequiredPerOutfit) || 0;
                    const costPerMeterFloat = parseFloat(costPerMeter) || 0;

                    if (currentLengthFloat <= 0 || lengthRequiredPerOutfitFloat <= 0 || costPerMeterFloat < 0) {
                        setOperationalError("Length must be positive and Cost must be non-negative.");
                        return;
                    }

                    const newDoc = {
                        name,
                        websiteProductName,
                        totalLength: currentLengthFloat, // Store initial length for usage calculation
                        currentLength: currentLengthFloat,
                        unit,
                        lengthRequiredPerOutfit: lengthRequiredPerOutfitFloat,
                        costPerMeter: costPerMeterFloat,
                        imageUrl: imageUrlToStore,
                        // Order Status Tracking Fields
                        lastOrderNumber: null,
                        currentOrderStatus: 'None', // Initial Status
                        updatedByEmail: userEmail,
                        updatedAt: serverTimestamp(),
                        createdAt: serverTimestamp(),
                    };

                    const fabricCollectionRef = collection(db, COLLECTION_PATH);
                    await addDoc(fabricCollectionRef, newDoc);

                    pushToGoogleSheet({
                        fabricName: newDoc.name,
                        websiteProductName: newDoc.websiteProductName,
                        type: 'ADD',
                        length: newDoc.totalLength,
                        unit: newDoc.unit,
                        cost: newDoc.costPerMeter,
                        orderNumber: 'INVENTORY START',
                        customerName: 'N/A',
                        loggedBy: userEmail
                    });

                    resetFormAndState();

                } catch (e) {
                    console.error("Error adding document: ", e);
                    setOperationalError(`Failed to add new fabric stock: ${e.message}. Check Firestore Security Rules!`);
                }
            };

            const handleDeleteFabric = async (id) => {
                if (!db || !userId) return;

                try {
                    const docRef = doc(db, COLLECTION_PATH, id);
                    await deleteDoc(docRef);
                    setOperationalError(null);
                } catch (e) {
                    console.error("Error deleting document: ", e);
                    setOperationalError(`Failed to delete fabric entry: ${e.message}. Check Security Rules.`);
                }
            };

            const handleOrderAssignment = async (e) => {
                e.preventDefault();

                if (!db || !userId) return;

                const { orderNumber, fabricId, lengthToCut, customerName, outputStyle, size } = orderForm;

                if (!orderNumber || !fabricId || !lengthToCut) {
                    setOperationalError("Order Number, Fabric Selection, and Cut Length are required to assign an order.");
                    return;
                }

                const fabric = fabrics.find(f => f.id === fabricId);
                const amountUsed = parseFloat(lengthToCut);

                if (!fabric || isNaN(amountUsed) || amountUsed <= 0) {
                    setOperationalError("Invalid fabric selection or amount to cut.");
                    return;
                }

                // --- Stock Check ---
                const newCurrentLength = fabric.currentLength - amountUsed;
                if (newCurrentLength < 0) {
                    setOperationalError(`Cannot cut ${amountUsed} ${fabric.unit}. Only ${fabric.currentLength.toFixed(2)} ${fabric.unit} remaining.`);
                    return;
                }

                // --- Prepare Data ---
                const finalOrderNumber = ORDER_PREFIX + orderNumber;
                const statusSentToTailor = 'Sent to Tailor';

                try {
                    const fabricDocRef = doc(db, COLLECTION_PATH, fabricId);

                    // 1. ADD NEW TRANSACTION (HISTORY)
                    const transactionData = {
                        amountUsed: amountUsed,
                        orderNumber: finalOrderNumber,
                        productName: outputStyle || 'N/A',
                        size: size || 'M',
                        customerName: customerName || 'N/A',
                        status: statusSentToTailor, // Status at cut time
                        usedByEmail: userEmail,
                        usedAt: serverTimestamp(),
                    };
                    await addDoc(collection(fabricDocRef, 'history'), transactionData);

                    // 2. UPDATE MAIN DOCUMENT (CUT, STATUS, ORDER DETAILS)
                    const updateData = {
                        currentLength: newCurrentLength,
                        // Set WIP status
                        currentOrderStatus: statusSentToTailor,
                        lastOrderNumber: finalOrderNumber,
                        lastProductName: transactionData.productName,
                        lastCustomerName: transactionData.customerName,
                        lastAmountUsed: transactionData.amountUsed,
                        updatedByEmail: userEmail,
                        updatedAt: serverTimestamp(),
                    };

                    await setDoc(fabricDocRef, updateData, { merge: true });

                    // 3. PUSH TO GOOGLE SHEET
                    pushToGoogleSheet({
                        fabricName: fabric.name,
                        websiteProductName: fabric.websiteProductName,
                        type: 'USE',
                        length: -amountUsed,
                        unit: fabric.unit,
                        cost: fabric.costPerMeter,
                        orderNumber: finalOrderNumber,
                        customerName: customerName || 'N/A',
                        loggedBy: userEmail
                    });

                    // Clear Order Form after successful update
                    setOrderForm({
                        orderNumber: '',
                        fabricId: '',
                        lengthToCut: '',
                        customerName: '',
                        outputStyle: '',
                        size: 'M',
                    });
                    setOperationalError(null);

                } catch (e) {
                    console.error("Error assigning order: ", e);
                    setOperationalError(`Failed to assign order: ${e.message}.`);
                }
            };


            // CONSOLIDATED FUNCTION: Handles ADDITION or DEDUCTION from modal
            const handleStockAdjustmentSubmit = async (e) => {
                e.preventDefault();

                if (!adjustmentFabricId || !adjustmentAmount) {
                    setOperationalError("Adjustment amount is required.");
                    return;
                }

                const id = adjustmentFabricId;
                const amount = adjustmentAmount;
                const isAddition = adjustmentType === 'ADD';

                const fabric = fabrics.find(f => f.id === id);
                if (!fabric) return;

                const amountFloat = parseFloat(amount);
                if (isNaN(amountFloat) || amountFloat <= 0) {
                    setOperationalError("Please enter a valid, positive amount.");
                    return;
                }

                let newCurrentLength;
                let transactionType;
                let lengthChange;

                if (isAddition) {
                    newCurrentLength = fabric.currentLength + amountFloat;
                    transactionType = 'ADDITION (Manual)';
                    lengthChange = amountFloat;
                } else {
                    newCurrentLength = fabric.currentLength - amountFloat;
                    transactionType = 'DEDUCTION (Manual)';
                    lengthChange = -amountFloat;

                    if (newCurrentLength < 0) {
                        setOperationalError(`Cannot deduct ${amountFloat} ${fabric.unit}. Only ${fabric.currentLength.toFixed(2)} ${fabric.unit} remaining.`);
                        return;
                    }
                }

                const defaultOrderNumber = `Manual-${isAddition ? 'ADD' : 'DEDUCT'}-${Date.now().toString(36).slice(-4)}`;

                try {
                    const fabricDocRef = doc(db, COLLECTION_PATH, id);

                    // 1. ADD NEW TRANSACTION TO SUBCOLLECTION (HISTORY)
                    const transactionData = {
                        amountUsed: amountFloat,
                        orderNumber: defaultOrderNumber,
                        productName: transactionType,
                        size: 'N/A',
                        customerName: 'N/A',
                        status: transactionType,
                        usedByEmail: userEmail,
                        usedAt: serverTimestamp(),
                    };
                    await addDoc(collection(fabricDocRef, 'history'), transactionData);

                    // 2. UPDATE MAIN DOCUMENT (CURRENT LENGTH)
                    const updateData = {
                        currentLength: newCurrentLength,
                        updatedByEmail: userEmail,
                        updatedAt: serverTimestamp(),
                    };
                    await setDoc(fabricDocRef, updateData, { merge: true });

                    // 3. PUSH TO GOOGLE SHEET
                    pushToGoogleSheet({
                        fabricName: fabric.name,
                        websiteProductName: fabric.websiteProductName,
                        type: transactionType,
                        length: lengthChange,
                        unit: fabric.unit,
                        cost: fabric.costPerMeter,
                        orderNumber: defaultOrderNumber,
                        customerName: 'N/A',
                        loggedBy: userEmail
                    });

                    closeAdjustmentModal();

                } catch (e) {
                    console.error("Error updating stock and history: ", e);
                    setOperationalError(`Failed to update stock: ${e.message}. Check Security Rules.`);
                }
            };


            const handleUpdateOrderStatus = async (fabricId, newStatus, orderNumber, price = null) => {
                if (!db || !userId) return;

                const fabric = fabrics.find(f => f.id === fabricId);
                if (!fabric) return;

                const isShipped = newStatus === 'Order Shipped (Completed)';

                if (newStatus === 'Received from Tailor' && (price === null || isNaN(parseFloat(price)) || parseFloat(price) <= 0)) {
                    setOperationalError("Please enter a valid final selling price before marking as received.");
                    return;
                }

                try {
                    const fabricDocRef = doc(db, COLLECTION_PATH, fabricId);

                    // 1. UPDATE MAIN DOCUMENT STATUS
                    const updateData = {
                        currentOrderStatus: newStatus,
                        updatedByEmail: userEmail,
                        updatedAt: serverTimestamp(),
                    };

                    // Add selling price if received
                    if (newStatus === 'Received from Tailor') {
                        updateData.finalSellingPrice = parseFloat(price);
                        updateData.receivedFromTailorDate = serverTimestamp();
                    }

                    // Clear order details if shipped
                    if (isShipped) {
                        updateData.lastOrderNumber = null;
                        updateData.lastProductName = null;
                        updateData.lastCustomerName = null;
                        updateData.lastAmountUsed = null;
                        updateData.finalSellingPrice = null;
                    }

                    await setDoc(fabricDocRef, updateData, { merge: true });

                    // 2. ADD NEW TRANSACTION TO HISTORY (for status change)
                    const transactionData = {
                        amountUsed: 0,
                        orderNumber: orderNumber,
                        productName: fabric.lastProductName || 'N/A',
                        size: 'N/A',
                        customerName: fabric.lastCustomerName || 'N/A',
                        status: newStatus,
                        usedByEmail: userEmail,
                        usedAt: serverTimestamp(),
                        finalSellingPrice: price,
                    };
                    await addDoc(collection(fabricDocRef, 'history'), transactionData);

                    // 3. PUSH TO GOOGLE SHEET
                    pushToGoogleSheet({
                        fabricName: fabric.name,
                        websiteProductName: fabric.websiteProductName,
                        type: isShipped ? 'SHIPPED/COMPLETED' : (newStatus === 'Received from Tailor' ? 'RECEIVED' : 'STATUS_CHANGE'),
                        length: 0,
                        unit: fabric.unit,
                        cost: fabric.costPerMeter,
                        orderNumber: orderNumber,
                        customerName: fabric.lastCustomerName || 'N/A',
                        loggedBy: userEmail
                    });

                    setOperationalError(null);
                    setSellingPrice('');
                    setAdjustmentFabricId(null); // Close input box if used

                } catch (e) {
                    console.error(`Error updating status to ${newStatus}: `, e);
                    setOperationalError(`Failed to update status: ${e.message}.`);
                }
            };


            // Functions to open/close modals
            const openAdjustmentModal = (id, type) => {
                setAdjustmentFabricId(id);
                setAdjustmentType(type);
                setAdjustmentAmount('');
                setIsStockAdjusting(true);
            }

            const closeAdjustmentModal = () => {
                setIsStockAdjusting(false);
                setAdjustmentAmount('');
                setAdjustmentFabricId(null);
            }

            const toggleHistory = (fabricId) => {
                setHistoryFabricId(historyFabricId === fabricId ? null : fabricId);
                setExpandedTransactionId(null);
            };

            const toggleTransactionDetails = (transactionId) => {
                setExpandedTransactionId(expandedTransactionId === transactionId ? null : transactionId);
            };


            // ------------------------------------
            // 5. DERIVED STATE & UI RENDERING
            // ------------------------------------

            const totalPotentialOutfits = useMemo(() => {
                // Safely access fabrics array
                if (!Array.isArray(fabrics)) return 0;
                return fabrics.reduce((sum, f) => sum + f.potentialOutfits, 0);
            }, [fabrics]);


            const totalInventoryValue = useMemo(() => {
                // Safely access fabrics array
                if (!Array.isArray(fabrics)) return 0;
                const total = fabrics.reduce((sum, f) => sum + f.totalCurrentCost, 0);
                return total.toFixed(2);
            }, [fabrics]);

            const availableFabrics = useMemo(() => {
                // Safely access fabrics array
                if (!Array.isArray(fabrics)) return [];
                return fabrics.filter(f => f.currentLength > 0);
            }, [fabrics]);


            // Filter fabrics currently assigned to an order (NOT SHIPPED)
            const wipFabrics = useMemo(() => {
                // Safely access fabrics array
                if (!Array.isArray(fabrics)) return [];
                return fabrics.filter(f => f.lastOrderNumber && f.currentOrderStatus !== 'Order Shipped (Completed)');
            }, [fabrics]);


            const ordersSentToTailor = useMemo(() => {
                return wipFabrics.filter(f => f.currentOrderStatus === 'Sent to Tailor' || !f.currentOrderStatus || f.currentOrderStatus === 'None');
            }, [wipFabrics]);

            const ordersReceivedFromTailor = useMemo(() => {
                return wipFabrics.filter(f => f.currentOrderStatus === 'Received from Tailor');
            }, [wipFabrics]);


            const totalOrdersSentToTailor = useMemo(() => {
                const uniqueOrders = new Set(ordersSentToTailor.map(f => f.lastOrderNumber));
                return uniqueOrders.size;
            }, [ordersSentToTailor]);

            const totalOrdersReceived = useMemo(() => {
                const uniqueOrders = new Set(ordersReceivedFromTailor.map(f => f.lastOrderNumber));
                return uniqueOrders.size;
            }, [ordersReceivedFromTailor]);

            const totalShippedValue = useMemo(() => {
                // Safely access fabrics array
                if (!Array.isArray(fabrics)) return 0;

                return fabrics
                    .filter(f => f.currentOrderStatus === 'Order Shipped (Completed)' && f.finalSellingPrice)
                    .reduce((sum, f) => sum + (f.finalSellingPrice || 0), 0)
                    .toFixed(2);
            }, [fabrics]);

            const totalShippedOrders = useMemo(() => {
                // Safely access fabrics array
                if (!Array.isArray(fabrics)) return 0;

                const shippedOrders = fabrics.filter(f => f.currentOrderStatus === 'Order Shipped (Completed)' && f.lastOrderNumber);
                const uniqueOrders = new Set(shippedOrders.map(f => f.lastOrderNumber));
                return uniqueOrders.size;

            }, [fabrics]);

            // Format Firestore Timestamp for display
            const formatTimestamp = (timestamp, timeOnly = false) => {
                if (timestamp && timestamp.toDate) {
                    const date = timestamp.toDate();
                    if (timeOnly) {
                        return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                    }
                    return date.toLocaleDateString('en-IN', { year: 'numeric', month: 'short', day: 'numeric' });
                }
                return 'N/A';
            };

            // --- NEW FINANCIALS DASHBOARD RENDERER ---
            const renderFinancialsDashboard = () => {
                const m = financialMetrics;

                // Helper for metric cards
                const MetricCard = ({ title, value, unit, icon: Icon, theme }) => (
                    <div className={`p-4 rounded-xl shadow-lg flex flex-col justify-between ${theme === 'dark' ? 'bg-dark-contrast text-white' : 'bg-white text-gray-800 border'}`}>
                        <div className="flex items-center justify-between mb-2">
                            <h3 className="text-sm font-semibold opacity-80 uppercase">{title}</h3>
                            <Icon className="w-5 h-5 opacity-90" />
                        </div>
                        <div>
                            <p className="text-3xl font-extrabold">{value}</p>
                            <p className="text-sm opacity-70">{unit}</p>
                        </div>
                    </div>
                );

                // Helper for list item
                const ItemCard = ({ name, value, isBest }) => (
                    <div className={`p-3 rounded-lg shadow-sm border ${isBest ? 'bg-green-50 border-green-300' : 'bg-red-50 border-red-300'} flex justify-between items-center`}>
                        <p className="font-semibold text-sm">{name}</p>
                        <p className={`font-bold text-sm ${isBest ? 'text-green-700' : 'text-red-700'}`}>{value}</p>
                    </div>
                );

                return (
                    <div className="p-6 space-y-8">
                        <h2 className="text-3xl font-bold text-gray-900 flex items-center"><DollarSign className="w-6 h-6 mr-3" /> Financial & Usage Overview</h2>

                        {/* Inventory Valuation Section */}
                        <div className="grid grid-cols-1 md:grid-cols-3 gap-6 border-b pb-6 border-gray-200">
                            <MetricCard
                                title="Remaining Stock Length"
                                value={m.totalLengthMeters}
                                unit="Meters (standardized)"
                                icon={Ruler}
                                theme="dark"
                            />
                            <MetricCard
                                title="Total Potential Outfit Cost"
                                value={`${RUPEE_ICON} ${totalInventoryValue}`}
                                unit="Based on current cost/meter"
                                icon={Tag}
                                theme="dark"
                            />
                            <MetricCard
                                title="Potential Revenue (Remaining Stock)"
                                value={`${RUPEE_ICON} ${m.totalPotentialRevenue}`}
                                unit={`Estimated @ ${RUPEE_ICON}${AVERAGE_SELLING_PRICE} per outfit`}
                                icon={DollarSign}
                                theme="dark"
                            />
                        </div>

                        {/* Usage Metrics Section */}
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-8 border-b pb-6 border-gray-200">
                            <div className="space-y-4">
                                <h3 className="text-xl font-semibold text-gray-700">Fabric Usage Analysis (Total Cut Length)</h3>

                                <h4 className="font-bold text-lg text-green-700">Most Used Fabric:</h4>
                                <ItemCard
                                    name={m.mostUsed.name}
                                    value={`${m.mostUsed.cut.toFixed(2)} m`}
                                    isBest={true}
                                />

                                <h4 className="font-bold text-lg text-red-700">Least Used Fabric (Non-Zero Cut):</h4>
                                <ItemCard
                                    name={m.leastUsed.name}
                                    value={`${m.leastUsed.cut.toFixed(2)} m`}
                                    isBest={false}
                                />

                                <p className="text-xs text-gray-500 pt-2">Note: Usage calculated as (Initial Total Length - Current Remaining Length).</p>
                            </div>

                            {/* Profitability Metrics Section */}
                            <div className="space-y-4">
                                <h3 className="text-xl font-semibold text-gray-700">Potential Profitability Analysis</h3>

                                <h4 className="font-bold text-lg text-green-700">Highest Potential Margin Fabric:</h4>
                                <ItemCard
                                    name={m.mostProfitable.name}
                                    value={`${RUPEE_ICON} ${m.mostProfitable.margin.toFixed(2)}`}
                                    isBest={true}
                                />

                                <h4 className="font-bold text-lg text-red-700">Lowest Potential Margin Fabric:</h4>
                                <ItemCard
                                    name={m.leastProfitable.name}
                                    value={`${RUPEE_ICON} ${m.leastProfitable.margin.toFixed(2)}`}
                                    isBest={false}
                                />

                                <p className="text-xs text-gray-500 pt-2">Note: Margin calculated as (Potential Revenue - Cost of Remaining Stock).</p>
                            </div>
                        </div>
                    </div>
                );
            }
            // --- END NEW FINANCIALS DASHBOARD RENDERER ---


            if (fatalError) {
                return (
                    <div className="p-8 bg-red-100 border-l-4 border-red-500 text-red-700 min-h-screen">
                        <p className="font-bold">FATAL APPLICATION ERROR</p>
                        <p>{fatalError}</p>
                        <p className="mt-2 text-sm text-gray-600">Please check your Firebase Console settings (Authentication & API Keys).</p>
                    </div>
                );
            }

            if (loading || !userId) {
                return (
                    <div className="flex items-center justify-center min-h-screen bg-gray-50">
                        <div className="spinner mr-3"></div>
                        <div className="text-xl font-medium text-blue-500">Connecting to Shared Database...</div>
                    </div>
                );
            }

            // ------------------------------------
            // 6. RENDER COMPONENTS
            // ------------------------------------


            const renderStockAdjustmentModal = () => {
                if (!isStockAdjusting || !adjustmentFabricId) return null;

                const fabric = fabrics.find(f => f.id === adjustmentFabricId);
                if (!fabric) return null;

                const isAdd = adjustmentType === 'ADD';
                const actionVerb = isAdd ? 'Add' : 'Deduct';
                const btnColor = isAdd ? 'bg-green-600 hover:bg-green-700' : 'btn-secondary';
                const actionTitle = isAdd ? 'Add Stock Back (Manual)' : 'Deduct Stock (Manual)';

                return (
                    <div className="modal-overlay" onClick={closeAdjustmentModal}>
                        <div
                            className="bg-white p-6 rounded-xl shadow-lg w-11/12 md:w-1/3"
                            onClick={(e) => e.stopPropagation()}
                        >
                            <h3 className="text-2xl font-bold mb-4 text-gray-800 flex items-center">
                                <Layers className="w-6 h-6 mr-2 text-ruby-red" /> {actionTitle}
                            </h3>
                            <p className="mb-4 text-gray-600">
                                Adjusting stock for: <span className="font-semibold">{fabric.name}</span>
                            </p>
                            <form onSubmit={handleStockAdjustmentSubmit} className="space-y-4">
                                <div>
                                    <label className="block text-sm font-medium text-gray-700">Amount to {actionVerb} ({fabric.unit})</label>
                                    <input
                                        type="number"
                                        step="0.01"
                                        min="0.01"
                                        required
                                        className="mt-1 block w-full rounded-md border-gray-300 p-2 border focus:ring-ruby-red focus:border-ruby-red"
                                        value={adjustmentAmount}
                                        onChange={(e) => setAdjustmentAmount(e.target.value)}
                                        placeholder={`Enter amount to ${actionVerb}`}
                                    />
                                    {!isAdd && (
                                        <p className="mt-1 text-xs text-gray-500">Remaining stock: {fabric.currentLength.toFixed(2)} {fabric.unit}</p>
                                    )}
                                </div>
                                <div className="flex space-x-3 justify-end">
                                    <button
                                        type="button"
                                        onClick={closeAdjustmentModal}
                                        className="bg-gray-300 text-gray-800 px-4 py-2 rounded-md font-medium hover:bg-gray-400 transition duration-150"
                                    >
                                        Cancel
                                    </button>
                                    <button
                                        type="submit"
                                        className={`text-white px-4 py-2 rounded-md font-medium transition duration-150 ${btnColor}`}
                                    >
                                        Confirm {actionVerb}
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                )
            }


            const renderWIPDashboard = () => {

                // Helper to render Order Item Card
                const renderOrderItemCard = (fabric, status) => {

                    // Check if the current fabric is the one we are setting a price for
                    const isReceiving = adjustmentFabricId === fabric.id && status === 'Sent to Tailor';

                    return (
                        <div key={fabric.id} className={`p-4 border rounded-lg shadow-sm ${status === 'Sent to Tailor' ? 'bg-yellow-50 border-yellow-300' : 'bg-green-100 border-green-600'}`}>
                            <div className="flex justify-between items-center mb-2">
                                <h4 className="font-bold text-gray-800">{fabric.lastOrderNumber || 'Order N/A'}</h4>
                                <span className={`text-sm font-semibold p-1 rounded-md ${status === 'Sent to Tailor' ? 'text-gold-600 bg-yellow-200' : 'text-green-800 bg-green-200'}`}>{fabric.currentOrderStatus}</span>
                            </div>
                            <p className="text-sm font-semibold text-gray-800 mb-2">Fabric: {fabric.name}</p>
                            <p className="text-sm text-gray-600">Customer: {fabric.lastCustomerName || 'N/A'}</p>
                            <p className="text-sm text-gray-600 mb-3">Amount Cut: <span className="text-dark-red font-semibold">{fabric.lastAmountUsed?.toFixed(2)} {fabric.unit}</span></p>

                            {status === 'Sent to Tailor' && (
                                isReceiving ? (
                                    <div className="flex flex-col space-y-2 pt-2 border-t border-gray-200">
                                        <input
                                            type="number"
                                            step="0.01"
                                            min="0.01"
                                            required
                                            placeholder="Final Selling Price (₹)"
                                            className="w-full p-2 border border-yellow-500 rounded-md shadow-sm"
                                            value={sellingPrice}
                                            onChange={(e) => setSellingPrice(e.target.value)}
                                        />
                                        <div className="flex space-x-2">
                                            <button
                                                onClick={() => handleUpdateOrderStatus(fabric.id, 'Received from Tailor', fabric.lastOrderNumber, sellingPrice)}
                                                className="flex-1 bg-dark-contrast text-white px-3 py-2 rounded-md font-medium hover:bg-gray-700 transition duration-150"
                                                disabled={!sellingPrice}
                                            >
                                                Confirm Received (Set Price)
                                            </button>
                                            <button
                                                onClick={() => setAdjustmentFabricId(null)}
                                                className="bg-gray-300 text-gray-800 px-3 py-2 rounded-md font-medium hover:bg-gray-400"
                                            >
                                                Cancel
                                            </button>
                                        </div>
                                    </div>
                                ) : (
                                    <button
                                        onClick={() => setAdjustmentFabricId(fabric.id)}
                                        className="w-full bg-dark-contrast text-white px-3 py-2 rounded-md font-medium hover:bg-gray-700 transition duration-150 mt-2"
                                    >
                                        Mark Received from Tailor
                                    </button>
                                )
                            )}

                            {status === 'Received from Tailor' && (
                                <>
                                    <p className="text-sm font-medium text-gray-700">Selling Price: <span className="font-bold text-green-600">₹ {fabric.finalSellingPrice?.toFixed(2) || 'N/A'}</span></p>
                                    <p className="text-xs text-gray-500 mb-3">Received: {formatTimestamp(fabric.receivedFromTailorDate)}</p>

                                    <button
                                        onClick={() => handleUpdateOrderStatus(fabric.id, 'Order Shipped (Completed)', fabric.lastOrderNumber)}
                                        className="w-full btn-primary text-white px-3 py-2 rounded-md font-medium transition duration-150 mt-2"
                                    >
                                        Mark Order Shipped
                                    </button>
                                </>
                            )}
                        </div>
                    );
                };

                return (
                    <div className="p-6">
                        {wipFabrics.length === 0 ? (
                            <div className="p-4 bg-gray-100 rounded-lg text-gray-600">No orders are currently in the production workflow. Start by assigning fabric!</div>
                        ) : (
                            <>
                                {/* Section 1: Sent to Tailor */}
                                <h4 className="text-xl font-semibold text-gray-700 mb-3 border-b pb-1 flex justify-between items-center">
                                    <span>Status 1: Sent to Tailor ({totalOrdersSentToTailor} Orders)</span>
                                </h4>
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-8">
                                    {ordersSentToTailor.length > 0 ? (
                                        ordersSentToTailor.map(f => renderOrderItemCard(f, 'Sent to Tailor'))
                                    ) : (
                                        <div className="md:col-span-2 p-4 bg-gray-100 rounded-lg text-gray-500 text-sm">No orders currently with the tailor.</div>
                                    )}
                                </div>

                                {/* Section 2: Received from Tailor */}
                                <h4 className="text-xl font-semibold text-gray-700 mb-3 border-b pb-1 flex justify-between items-center">
                                    <span>Status 2: Received from Tailor (Ready to Ship) ({totalOrdersReceived} Orders)</span>
                                </h4>
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    {ordersReceivedFromTailor.length > 0 ? (
                                        ordersReceivedFromTailor.map(f => renderOrderItemCard(f, 'Received from Tailor'))
                                    ) : (
                                        <div className="md:col-span-2 p-4 bg-gray-100 rounded-lg text-gray-500 text-sm">No garments are currently ready for shipping.</div>
                                    )}
                                </div>
                            </>
                        )}
                    </div>
                );
            }

            const renderOrderAssignmentForm = () => (
                <div className="p-6">
                    <h2 className="text-2xl font-semibold text-gray-800 mb-4 flex items-center"><ShoppingCart className="w-5 h-5 mr-2" /> Assign New Order Cut</h2>
                    <form onSubmit={handleOrderAssignment} className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">

                        {/* 1. Order Number */}
                        <div className="form-input-group">
                            <label className="block text-sm font-medium text-gray-700">Order Number (Required)</label>
                            <input
                                type="text"
                                required
                                className="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border focus:ring-ruby-red focus:border-ruby-red"
                                value={orderForm.orderNumber}
                                onChange={(e) => setOrderForm({ ...orderForm, orderNumber: e.target.value })}
                                placeholder="e.g., 1005 (will be #PoshkahFC-1005)"
                            />
                        </div>

                        {/* 2. Select Fabric */}
                        <div className="form-input-group">
                            <label className="block text-sm font-medium text-gray-700">Select Fabric (Available Stock)</label>
                            <select
                                required
                                className="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border focus:ring-ruby-red focus:border-ruby-red"
                                value={orderForm.fabricId}
                                onChange={(e) => setOrderForm({ ...orderForm, fabricId: e.target.value })}
                            >
                                <option value="">--- Choose Fabric ---</option>
                                {availableFabrics.map(f => (
                                    <option key={f.id} value={f.id} disabled={f.currentLength < f.lengthRequiredPerOutfit}>
                                        {f.name} ({f.currentLength.toFixed(2)} {f.unit} left)
                                    </option>
                                ))}
                            </select>
                        </div>

                        {/* 3. Length to Cut */}
                        <div className="form-input-group">
                            <label className="block text-sm font-medium text-gray-700">Length to Cut ({selectedFabric?.unit || 'm'})</label>
                            <input
                                type="number"
                                step="0.01"
                                min="0.01"
                                required
                                className="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border focus:ring-ruby-red focus:border-ruby-red"
                                value={orderForm.lengthToCut}
                                onChange={(e) => setOrderForm({ ...orderForm, lengthToCut: e.target.value })}
                                placeholder={`Needed: ${selectedFabric?.lengthRequiredPerOutfit?.toFixed(2) || '---'}`}
                            />
                            {selectedFabric && orderForm.lengthToCut > selectedFabric.currentLength && (
                                <p className="mt-1 text-xs text-red-600 font-semibold">! Warning: Exceeds stock ({selectedFabric.currentLength.toFixed(2)} {selectedFabric.unit})</p>
                            )}
                        </div>

                        {/* 4. Customer Name */}
                        <div className="form-input-group">
                            <label className="block text-sm font-medium text-gray-700">Customer Name</label>
                            <input
                                type="text"
                                className="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border focus:ring-ruby-red focus:border-ruby-red"
                                value={orderForm.customerName}
                                onChange={(e) => setOrderForm({ ...orderForm, customerName: e.target.value })}
                                placeholder="Customer Name"
                            />
                        </div>

                        {/* 5. Output Style / Product Name */}
                        <div className="form-input-group">
                            <label className="block text-sm font-medium text-gray-700">Output Style / Product Name</label>
                            <input
                                type="text"
                                required
                                className="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border focus:ring-ruby-red focus:border-ruby-red"
                                value={orderForm.outputStyle}
                                onChange={(e) => setOrderForm({ ...orderForm, outputStyle: e.target.value })}
                                placeholder="Kurti, Co-ord Set, Dress, etc."
                            />
                        </div>

                        {/* 6. Size */}
                        <div className="form-input-group">
                            <label className="block text-sm font-medium text-gray-700">Size</label>
                            <select
                                required
                                className="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border focus:ring-ruby-red focus:border-ruby-red"
                                value={orderForm.size}
                                onChange={(e) => setOrderForm({ ...orderForm, size: e.target.value })}
                            >
                                <option value="S">S</option>
                                <option value="M">M</option>
                                <option value="L">L</option>
                                <option value="XL">XL</option>
                                <option value="XXL">XXL</option>
                            </select>
                        </div>

                        {/* 7. Summary / Action */}
                        <div className="md:col-span-2 lg:col-span-2 flex flex-col justify-end">
                            <div className="h-10 mb-2">
                                {/* Placeholder for visual alignment or future notes */}
                            </div>
                            <button
                                type="submit"
                                className={`w-full justify-center inline-flex items-center px-4 py-2 border border-transparent rounded-md shadow-sm text-base font-medium text-white transition duration-150 btn-secondary`}
                            >
                                <Scissors className="w-5 h-5 mr-2" /> Assign Fabric & Mark WIP
                            </button>
                        </div>

                    </form>
                </div>
            );


            const renderAddStock = () => (
                <div className="p-6">
                    <h2 className="text-2xl font-semibold text-gray-800 mb-4 flex items-center"><Plus className="w-5 h-5 mr-2" /> Add New Fabric Stock (Bulk Input)</h2>
                    <form onSubmit={handleAddFabricWrapper} className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">

                        {/* 1. Fabric Name (Physical SKU) */}
                        <div className="form-input-group">
                            <label className="block text-sm font-medium text-gray-700">Fabric Name (Internal SKU)</label>
                            <input
                                type="text"
                                required
                                className="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border focus:ring-ruby-red focus:border-ruby-red"
                                value={newFabric.name}
                                onChange={(e) => setNewFabric({ ...newFabric, name: e.target.value })}
                            />
                        </div>

                        {/* 2. Website Product Name (NEW INPUT) */}
                        <div className="form-input-group">
                            <label className="block text-sm font-medium text-gray-700">Website Product Name</label>
                            <input
                                type="text"
                                className="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border focus:ring-ruby-red focus:border-ruby-red"
                                value={newFabric.websiteProductName}
                                onChange={(e) => setNewFabric({ ...newFabric, websiteProductName: e.target.value })}
                                placeholder="e.g., 'Emerald Bloom Kurti'"
                            />
                        </div>

                        {/* 3. Total Length */}
                        <div className="form-input-group">
                            <label className="block text-sm font-medium text-gray-700">Total Length in Stock</label>
                            <div className="mt-1 flex rounded-md shadow-sm">
                                <input
                                    type="number"
                                    step="0.01"
                                    min="0.1"
                                    required
                                    className="flex-1 block w-full rounded-l-md border-gray-300 p-2 border focus:ring-ruby-red focus:border-ruby-red"
                                    value={newFabric.totalLength}
                                    onChange={(e) => setNewFabric({ ...newFabric, totalLength: e.target.value })}
                                />
                                <select
                                    className="inline-flex items-center px-3 rounded-r-md border border-l-0 border-gray-300 bg-gray-50 text-gray-500 text-sm"
                                    value={newFabric.unit}
                                    onChange={(e) => setNewFabric({ ...newFabric, unit: e.target.value })}
                                >
                                    <option value="meters">meters</option>
                                    <option value="yards">yards</option>
                                </select>
                            </div>
                        </div>

                        {/* 4. Cost Per Meter */}
                        <div className="form-input-group">
                            <label className="block text-sm font-medium text-gray-700">Cost per Meter (₹)</label>
                            <input
                                type="number"
                                step="0.01"
                                min="0"
                                required
                                className="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border focus:ring-ruby-red focus:border-ruby-red"
                                value={newFabric.costPerMeter}
                                onChange={(e) => setNewFabric({ ...newFabric, costPerMeter: e.target.value })}
                            />
                        </div>


                        {/* 5. Length Required Per Outfit */}
                        <div className="form-input-group">
                            <label className="block text-sm font-medium text-gray-700">Length Required per Outfit</label>
                            <input
                                type="number"
                                step="0.01"
                                min="0.1"
                                required
                                className="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border focus:ring-ruby-red focus:border-ruby-red"
                                value={newFabric.lengthRequiredPerOutfit}
                                onChange={(e) => setNewFabric({ ...newFabric, lengthRequiredPerOutfit: e.target.value })}
                            />
                            <p className="mt-1 text-xs text-gray-500">Meters to make one average outfit.</p>
                        </div>

                        {/* Image Capture / Gallery Buttons (Spans full width) */}
                        <div className="lg:col-span-4 md:col-span-2 pt-2 form-input-group">
                            <label className="block text-sm font-medium text-gray-700 mb-2">Fabric Image (Choose Option)</label>
                            <div className="flex space-x-4">
                                {/* Hidden input for camera */}
                                <input
                                    type="file"
                                    accept="image/*"
                                    capture="environment"
                                    ref={cameraInputRef}
                                    onChange={(e) => handleFileChange(e, setNewFabricImageFile)}
                                    className="hidden"
                                />
                                {/* Button to trigger camera */}
                                <button
                                    type="button"
                                    onClick={() => cameraInputRef.current.click()}
                                    className="flex flex-col items-center justify-center p-3 w-32 h-20 bg-ruby-red-100 text-dark-red rounded-lg shadow-md hover:bg-ruby-red-100 transition duration-150"
                                >
                                    <Camera className="w-6 h-6" />
                                    <span className="text-xs mt-1">Take Photo</span>
                                </button>

                                {/* Hidden input for gallery */}
                                <input
                                    type="file"
                                    accept="image/*"
                                    ref={galleryInputRef}
                                    onChange={(e) => handleFileChange(e, setNewFabricImageFile)}
                                    className="hidden"
                                />
                                {/* Button to trigger gallery */}
                                <button
                                    type="button"
                                    onClick={() => galleryInputRef.current.click()}
                                    className="flex flex-col items-center justify-center p-3 w-32 h-20 bg-gold-100 text-dark-red rounded-lg shadow-md hover:bg-gray-200 transition duration-150"
                                >
                                    <ImageIcon className="w-6 h-6" />
                                    <span className="text-xs mt-1">Upload from Gallery</span>
                                </button>
                                <div className="flex flex-col justify-center ml-4">
                                    {newFabricImageFile && (
                                        <p className="text-xs text-green-600 font-semibold">
                                            File selected: {newFabricImageFile.name}
                                            {(newFabricImageFile.size / 1024).toFixed(0) > 750 ?
                                                <span className="text-red-600 font-bold ml-2"> (Too Large! Limit 750 KB)</span> : ''
                                            }
                                        </p>
                                    )}
                                </div>
                            </div>

                            <p className="mt-1 text-xs text-gray-500">
                                Images are stored in Firebase documents as a Base64 string (Max 750 KB).
                            </p>
                        </div>

                        {/* Submit Button (Spans full width) */}
                        <div className="lg:col-span-4 md:col-span-2 pt-2 form-input-group">
                            <button
                                type="submit"
                                disabled={isUploading || !db}
                                className={`w-full justify-center inline-flex items-center px-4 py-2 border border-transparent rounded-md shadow-sm text-base font-medium text-white transition duration-150 ${isUploading ? 'bg-gray-500 cursor-not-allowed' : 'btn-primary'}`}
                            >
                                {isUploading ? (
                                    <>
                                        <span className="spinner mr-2"></span> Uploading...
                                    </>
                                ) : (
                                    <>
                                        <Plus className="w-5 h-5 mr-2" /> Add Fabric to Stock
                                    </>
                                )}
                            </button>
                        </div>
                    </form>
                </div>
            );

            const renderSortedOrdersTable = () => (
                <div className="p-6">
                    <h2 className="text-2xl font-semibold text-gray-800 mb-4 flex items-center"><ListOrdered className="w-5 h-5 mr-2" /> Order History (Sorted by #)</h2>

                    {orderedFabricsSorted.length === 0 ? (
                        <div className="p-4 bg-gray-100 rounded-lg text-gray-600">No fabrics have an assigned order number yet.</div>
                    ) : (
                        <div className="overflow-x-auto bg-white rounded-lg shadow-md">
                            <table className="min-w-full divide-y divide-gray-200">
                                <thead className="bg-gray-50">
                                    <tr>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Order #</th>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fabric / Product</th>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Customer</th>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Cut (m/y)</th>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Last Update</th>
                                    </tr>
                                </thead>
                                <tbody className="bg-white divide-y divide-gray-200">
                                    {orderedFabricsSorted.map((f) => (
                                        <tr key={f.id} className="hover:bg-gray-50">
                                            <td className="px-6 py-4 whitespace-nowrap text-sm font-medium text-ruby-red">{f.lastOrderNumber}</td>
                                            <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                                <p className="font-semibold">{f.name}</p>
                                                <p className="text-xs text-gray-500">{f.lastProductName}</p>
                                            </td>
                                            <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-700">{f.lastCustomerName}</td>
                                            <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-700 font-mono text-red-600">{f.lastAmountUsed?.toFixed(2)} {f.unit}</td>
                                            <td className="px-6 py-4 whitespace-nowrap text-sm">
                                                <span className={`px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${f.currentOrderStatus === 'Order Shipped (Completed)' ? 'bg-green-100 text-green-800' : f.currentOrderStatus === 'Received from Tailor' ? 'bg-blue-100 text-blue-800' : f.currentOrderStatus === 'Sent to Tailor' ? 'bg-yellow-100 text-yellow-800' : 'bg-gray-100 text-gray-800'}`}>
                                                    {f.currentOrderStatus}
                                                </span>
                                            </td>
                                            <td className="px-6 py-4 whitespace-nowrap text-xs text-gray-500">{formatTimestamp(f.updatedAt)}</td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    )}
                </div>
            );


            const renderTabContent = () => {
                if (activeTab === 'orders') {
                    return renderOrderAssignmentForm();
                } else if (activeTab === 'ordersSorted') {
                    return renderSortedOrdersTable();
                } else if (activeTab === 'wip') {
                    return renderWIPDashboard();
                } else if (activeTab === 'stock') {
                    return renderAddStock();
                } else if (activeTab === 'financials') {
                    return renderFinancialsDashboard();
                }
                return null;
            };

            return (
                <div className="p-4 md:p-8 bg-gray-50 min-h-screen font-sans">
                    {selectedImageUrl && (
                        <div className="modal-overlay" onClick={() => setSelectedImageUrl(null)}>
                            <button className="modal-close-btn" onClick={() => setSelectedImageUrl(null)} title="Close">
                                <X className="w-6 h-6" />
                            </button>
                            <div className="modal-content" onClick={(e) => e.stopPropagation()}>
                                <img
                                    src={selectedImageUrl}
                                    alt="Enlarged Fabric Image"
                                    style={{
                                        maxWidth: '100%',
                                        maxHeight: '100vh',
                                        objectFit: 'contain'
                                    }}
                                />
                            </div>
                        </div>
                    )}
                    {renderStockAdjustmentModal()}

                    <div className="max-w-6xl mx-auto">
                        <h1 className="text-4xl font-extrabold text-gray-900 mb-2">Poshakh Fabric Stock Manager</h1>
                        <p className="text-sm text-gray-500 mb-6">
                            User ID: <span className="font-mono bg-gray-200 p-1 rounded-md text-xs">{userEmail}</span>
                        </p>

                        {/* Operational Error Display */}
                        {operationalError && (
                            <div className="p-3 mb-6 bg-red-100 border-l-4 border-red-500 text-red-700 rounded-md">
                                <p className="font-bold">Action Status</p>
                                <p className="text-sm">{operationalError}</p>
                                <button onClick={() => setOperationalError(null)} className="text-xs text-red-600 font-medium mt-1">Dismiss</button>
                            </div>
                        )}

                        {/* Global Stats */}
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">

                            {/* 1. Total Fabrics Card */}
                            <div className="card bg-metric text-metric p-6 rounded-xl shadow-lg flex items-center">
                                <Gauge className="w-8 h-8 mr-4 icon-metric" />
                                <div>
                                    <p className="text-sm opacity-80 uppercase font-semibold">Total Fabric SKUs</p>
                                    <p className="text-3xl font-bold">{fabrics.length}</p>
                                </div>
                            </div>

                            {/* 2. Potential Outfits Card */}
                            <div className="card bg-metric text-metric p-6 rounded-xl shadow-lg flex items-center">
                                <Shirt className="w-8 h-8 mr-4 icon-metric" />
                                <div>
                                    <p className="text-sm opacity-80 uppercase font-semibold">Potential Outfits</p>
                                    <p className="text-3xl font-bold">{totalPotentialOutfits}</p>
                                </div>
                            </div>

                            {/* 3. Total Inventory Value Card (Cost to You) */}
                            <div className="card bg-metric text-metric p-6 rounded-xl shadow-lg flex items-center">
                                <Tag className="w-8 h-8 mr-4 icon-metric" />
                                <div>
                                    <p className="text-sm opacity-80 uppercase font-semibold">Total Inventory Value (Cost)</p>
                                    <p className="text-3xl font-bold">₹ {totalInventoryValue}</p>
                                </div>
                            </div>

                            {/* 4. Total Shipped Value Card (Sales Value) */}
                            <div className="card bg-metric text-metric p-6 rounded-xl shadow-lg flex items-center">
                                <Tag className="w-8 h-8 mr-4 icon-metric" />
                                <div>
                                    <p className="text-sm opacity-80 uppercase font-semibold">Total Shipped Value</p>
                                    <p className="text-3xl font-bold">₹ {totalShippedValue}</p>
                                </div>
                            </div>

                            {/* 5. Orders Sent to Tailor */}
                            <div className="card bg-metric text-metric p-6 rounded-xl shadow-lg flex items-center">
                                <Clock className="w-8 h-8 mr-4 icon-metric" />
                                <div>
                                    <p className="text-sm opacity-80 uppercase font-semibold">Sent to Tailor (Status 1)</p>
                                    <p className="text-3xl font-bold">{totalOrdersSentToTailor}</p>
                                </div>
                            </div>

                            {/* 6. Ready to Ship */}
                            <div className="card bg-metric text-metric p-6 rounded-xl shadow-lg flex items-center">
                                <CheckCircle className="w-8 h-8 mr-4 icon-metric" />
                                <div>
                                    <p className="text-sm opacity-80 uppercase font-semibold">Received (Status 2)</p>
                                    <p className="text-3xl font-bold">{totalOrdersReceived}</p>
                                </div>
                            </div>

                            {/* 7. Total Shipped Count */}
                            <div className="card bg-metric text-metric p-6 rounded-xl shadow-lg flex items-center">
                                <CheckCircle className="w-8 h-8 mr-4 icon-metric" />
                                <div>
                                    <p className="text-sm opacity-80 uppercase font-semibold">Total Orders Shipped</p>
                                    <p className="text-3xl font-bold">{totalShippedOrders}</p>
                                </div>
                            </div>

                            {/* 8. Total Orders WIP */}
                            <div className="card bg-metric text-metric p-6 rounded-xl shadow-lg flex items-center">
                                <ShoppingCart className="w-8 h-8 mr-4 icon-metric" />
                                <div>
                                    <p className="text-sm opacity-80 uppercase font-semibold">Total Orders WIP</p>
                                    <p className="text-3xl font-bold">{totalOrdersSentToTailor + totalOrdersReceived}</p>
                                </div>
                            </div>
                        </div>

                        {/* TAB BAR */}
                        <div className="flex mb-0 -space-x-1">
                            <button
                                className={`tab-button ${activeTab === 'orders' ? 'tab-active' : 'tab-inactive'}`}
                                onClick={() => setActiveTab('orders')}
                            >
                                <span className="flex items-center"><Scissors className="w-5 h-5 mr-2" /> Order Assignment</span>
                            </button>
                            <button
                                className={`tab-button ${activeTab === 'wip' ? 'tab-active' : 'tab-inactive'}`}
                                onClick={() => setActiveTab('wip')}
                            >
                                <span className="flex items-center"><Clock className="w-5 h-5 mr-2" /> WIP Order Status</span>
                            </button>
                            <button
                                className={`tab-button ${activeTab === 'stock' ? 'tab-active' : 'tab-inactive'}`}
                                onClick={() => setActiveTab('stock')}
                            >
                                <span className="flex items-center"><Layers className="w-5 h-5 mr-2" /> Stock Management</span>
                            </button>
                            <button
                                className={`tab-button ${activeTab === 'ordersSorted' ? 'tab-active' : 'tab-inactive'}`}
                                onClick={() => setActiveTab('ordersSorted')}
                            >
                                <span className="flex items-center"><ListOrdered className="w-5 h-5 mr-2" /> Order History (Sorted by #)</span>
                            </button>
                            <button
                                className={`tab-button ${activeTab === 'financials' ? 'tab-active' : 'tab-inactive'}`}
                                onClick={() => setActiveTab('financials')}
                            >
                                <span className="flex items-center"><DollarSign className="w-5 h-5 mr-2" /> Financials</span>
                            </button>
                        </div>

                        {/* TAB CONTENT */}
                        <div className="bg-white rounded-xl rounded-tl-none shadow-lg mb-8 p-0">
                            {renderTabContent()}
                        </div>

                        {/* Current Stock List */}
                        <h2 className="text-3xl font-bold text-gray-900 mb-6">Inventory Status ({fabrics.length} items)</h2>

                        {fabrics.length === 0 ? (
                            <div className="p-8 text-center bg-white rounded-xl shadow-lg text-gray-500">No fabric stock recorded yet. Use the 'Stock Management' tab to add an item!</div>
                        ) : (
                            <div className="grid grid-cols-1 gap-6">
                                {fabrics.map((fabric) => {
                                    const isWIPActive = fabric.lastOrderNumber && fabric.currentOrderStatus !== 'Order Shipped (Completed)';
                                    return (
                                        <div key={fabric.id} className="card bg-white p-5 rounded-xl shadow-md flex flex-col space-y-4">

                                            {/* Main Item Row */}
                                            <div className="relative z-10 flex flex-col md:flex-row justify-between items-start md:items-center w-full h-full space-y-4 md:space-y-0">

                                                {/* FABRIC DETAILS SECTION (Left 60%) */}
                                                <div className="w-full md:w-3/5 p-0">
                                                    <div className="flex items-start space-x-4">

                                                        {/* Image Button for Zoom */}
                                                        <button
                                                            onClick={() => setSelectedImageUrl(fabric.imageUrl)}
                                                            className="cursor-pointer flex-shrink-0 mt-1"
                                                        >
                                                            <img
                                                                src={fabric.imageUrl}
                                                                alt={fabric.name}
                                                                className="w-20 h-20 object-cover rounded-lg shadow-lg border border-gray-300 hover:opacity-90 transition duration-150"
                                                                onError={(e) => {
                                                                    e.target.onerror = null;
                                                                    e.target.src = `https://placehold.co/80x80/880000/ffffff?text=${(fabric.name || 'FAB').substring(0, 3).toUpperCase()}`;
                                                                }}
                                                            />
                                                        </button>

                                                        {/* Fabric Details (Contrasting White Box) */}
                                                        <div className="bg-white p-3 rounded-lg shadow-md flex-1">
                                                            <h3 className="text-xl font-bold text-gray-900 mb-1">{fabric.name}</h3>
                                                            <div className="text-sm text-gray-600 space-y-1">
                                                                <p className="flex items-center"><Ruler className="w-4 h-4 mr-2 text-ruby-red" /> Stock: {fabric.currentLength.toFixed(2)} {fabric.unit}</p>
                                                                <p className="flex items-center"><Shirt className="w-4 h-4 mr-2 text-light-gold" /> Req. per Outfit: {fabric.lengthRequiredPerOutfit.toFixed(2)} {fabric.unit}</p>
                                                                <p className="flex items-center text-green-600"><Tag className="w-4 h-4 mr-2" /> Current Cost: ₹ {fabric.totalCurrentCost.toFixed(2)}</p>
                                                                {fabric.websiteProductName && (
                                                                    <p className="text-xs text-gray-500 italic">Product: {fabric.websiteProductName}</p>
                                                                )}
                                                            </div>
                                                            <p className="text-xs text-gray-400 mt-2">
                                                                Last updated:
                                                                <span className="font-semibold text-gray-600 ml-1">{formatTimestamp(fabric.updatedAt)}</span> by
                                                                <span className="font-semibold text-gray-600 ml-1">{fabric.updatedByEmail || 'N/A'}</span>
                                                            </p>
                                                        </div>
                                                    </div>
                                                </div>

                                                {/* Stock & Calculation (Right 40%) */}
                                                <div className="w-full md:w-2/5 flex flex-col space-y-3 mt-4 md:mt-0">
                                                    {/* 1. Stats Box (Contrasting White Box) */}
                                                    <div className="bg-white p-3 rounded-lg shadow-md">
                                                        <div className="flex justify-between items-center bg-gray-100 p-3 rounded-lg">
                                                            <div>
                                                                <p className="text-sm font-medium text-gray-500">Remaining Stock</p>
                                                                <p className="text-2xl font-extrabold text-ruby-red">
                                                                    {fabric.currentLength.toFixed(2)} {fabric.unit}
                                                                </p>
                                                            </div>
                                                            <div>
                                                                <p className="text-sm font-medium text-gray-500">Potential Outfits</p>
                                                                <p className="text-2xl font-extrabold text-light-gold">
                                                                    {fabric.potentialOutfits}
                                                                </p>
                                                            </div>
                                                        </div>
                                                    </div>

                                                    {/* 2. Order Status Display */}
                                                    {fabric.currentOrderStatus && fabric.currentOrderStatus !== 'None' && (
                                                        <div className={`text-sm font-semibold p-2 rounded-lg border flex items-center justify-between ${isWIPActive ? 'bg-yellow-100 border-yellow-300' : 'bg-green-100 border-green-300'}`}>
                                                            <span className="text-gray-700 mr-2">Order Status:</span>
                                                            <span className={`${isWIPActive ? 'text-gold-600' : 'text-green-600'}`}>{fabric.currentOrderStatus}</span>
                                                        </div>
                                                    )}

                                                    {/* 3. Action Buttons */}
                                                    <div className="flex space-x-2">

                                                        {/* VIEW HISTORY BUTTON */}
                                                        <button
                                                            onClick={() => toggleHistory(fabric.id)}
                                                            className={`flex-1 px-4 py-2 rounded-md font-medium transition duration-150 shadow-md flex items-center justify-center ${historyFabricId === fabric.id ? 'btn-primary text-white' : 'bg-gray-200 text-gray-800 hover:bg-gray-300'}`}
                                                        >
                                                            {historyFabricId === fabric.id ? 'Hide History' : 'View History'}
                                                        </button>

                                                        {/* ADD STOCK BUTTON */}
                                                        <button
                                                            onClick={() => openAdjustmentModal(fabric.id, 'ADD')}
                                                            disabled={isWIPActive}
                                                            className={`bg-green-100 text-green-600 px-4 py-2 rounded-md font-medium transition duration-150 shadow-md ${isWIPActive ? 'opacity-50 cursor-not-allowed' : 'hover:bg-green-200'}`}
                                                            title={isWIPActive ? 'Manage status in WIP tab' : 'Add Stock Back'}
                                                        >
                                                            <Plus className="w-5 h-5" />
                                                        </button>

                                                        {/* DEDUCT STOCK BUTTON */}
                                                        <button
                                                            onClick={() => openAdjustmentModal(fabric.id, 'DEDUCT')}
                                                            disabled={isWIPActive}
                                                            className={`btn-secondary text-white px-4 py-2 rounded-md font-medium transition duration-150 shadow-md ${isWIPActive ? 'opacity-50 cursor-not-allowed' : ''}`}
                                                            title={isWIPActive ? 'Manage status in WIP tab' : 'Use Stock (Deduct)'}
                                                        >
                                                            <Scissors className="w-5 h-5" />
                                                        </button>

                                                        {/* DELETE BUTTON */}
                                                        <button
                                                            onClick={() => handleDeleteFabric(fabric.id)}
                                                            className="p-3 bg-red-100 text-red-600 rounded-md hover:bg-red-200 transition duration-150"
                                                            title="Delete Fabric Entry"
                                                        >
                                                            <Trash2 className="w-5 h-5" />
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>

                                            {/* History View Container */}
                                            {historyFabricId === fabric.id && (
                                                <div className="w-full pt-4 border-t border-gray-200 mt-4 relative z-10">
                                                    <div className="bg-white p-4 rounded-lg shadow-inner">
                                                        <h4 className="text-lg font-semibold text-gray-700 mb-3 flex items-center"><Clock className="w-5 h-5 mr-2 text-ruby-red" /> Usage History ({transactionHistory.length} logs)</h4>

                                                        {transactionHistory.length === 0 ? (
                                                            <p className="text-sm text-gray-500 ml-2">No usage logs found for this fabric.</p>
                                                        ) : (
                                                            <div className="space-y-2">
                                                                {transactionHistory.map((tx) => (
                                                                    <div key={tx.id} className="bg-white border border-gray-200 rounded-lg overflow-hidden">
                                                                        {/* Summary Bar */}
                                                                        <button
                                                                            type="button"
                                                                            onClick={() => toggleTransactionDetails(tx.id)}
                                                                            className="w-full flex justify-between items-center p-3 text-left hover:bg-gray-50 transition duration-100"
                                                                        >
                                                                            <div className="flex items-center text-sm font-semibold">
                                                                                <span className="text-ruby-red mr-3">{tx.orderNumber || 'N/A'}</span>
                                                                                {tx.amountUsed > 0 && (
                                                                                    <span className="text-red-600 mr-3 font-extrabold">-{tx.amountUsed.toFixed(2)} {fabric.unit}</span>
                                                                                )}
                                                                                <span className="text-gray-500 font-normal flex items-center"><Clock className="w-4 h-4 mr-1 ml-2" /> {formatTimestamp(tx.usedAt)}</span>
                                                                            </div>
                                                                            {expandedTransactionId === tx.id ? <ChevronDown className="w-5 h-5 text-gray-600" /> : <ChevronRight className="w-5 h-5 text-gray-600" />}
                                                                        </button>

                                                                        {/* Expanded Details */}
                                                                        {expandedTransactionId === tx.id && (
                                                                            <div className="p-3 pt-0 border-t border-gray-200 bg-gray-50 text-xs space-y-1">
                                                                                <p><span className="font-semibold text-gray-700">Product:</span> {tx.productName || 'N/A'} (Size: {tx.size || 'N/A'})</p>
                                                                                <p><span className="font-semibold text-gray-700">Customer:</span> {tx.customerName || 'N/A'}</p>
                                                                                <p><span className="font-semibold text-gray-700">Order Status at Cut:</span> {tx.status || 'N/A'}</p>
                                                                                <p><span className="font-semibold text-gray-700">Logged By:</span> {tx.usedByEmail || 'N/A'} at {formatTimestamp(tx.usedAt, true)}</p>
                                                                            </div>
                                                                        )}
                                                                    </div>
                                                                ))}
                                                            </div>
                                                        )}
                                                    </div>
                                                </div>
                                            )}


                                        </div>
                                    );
                                })}
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        // Render the App
        const container = document.getElementById('root');
        // Use React 18's createRoot API
        const root = ReactDOM.createRoot(container);
        root.render(<App />);
    </script>
</body>

</html>