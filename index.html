<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fabric Stock Manager</title>
    <!-- REMOVED EXTERNAL TAILWIND SCRIPT -->
    <style>
        /* BASE STYLES & FONTS */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&display=swap');

        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8f9fa;
            /* Creamy background */
            min-height: 100vh;
            padding: 1rem;
        }

        /* --- UI UTILITY CLASSES (Hardcoded CSS) --- */
        .max-w-6xl {
            max-width: 72rem;
        }

        .mx-auto {
            margin-left: auto;
            margin-right: auto;
        }

        .p-4 {
            padding: 1rem;
        }

        .md\:p-8 {
            padding: 2rem;
        }

        .min-h-screen {
            min-height: 100vh;
        }

        .bg-gray-50 {
            background-color: #f8f9fa;
        }

        .font-sans {
            font-family: 'Inter', sans-serif;
        }

        .mb-2 {
            margin-bottom: 0.5rem;
        }

        .mb-4 {
            margin-bottom: 1rem;
        }

        .mb-6 {
            margin-bottom: 1.5rem;
        }

        .mb-8 {
            margin-bottom: 2rem;
        }

        .mt-1 {
            margin-top: 0.25rem;
        }

        .mt-2 {
            margin-top: 0.5rem;
        }

        .mt-3 {
            margin-top: 0.75rem;
        }

        .mr-2 {
            margin-right: 0.5rem;
        }

        .mr-3 {
            margin-right: 0.75rem;
        }

        .mr-4 {
            margin-right: 1rem;
        }

        .ml-1 {
            margin-left: 0.25rem;
        }

        .ml-2 {
            margin-left: 0.5rem;
        }

        .ml-4 {
            margin-left: 1rem;
        }

        .space-x-2>*+* {
            margin-left: 0.5rem;
        }

        .space-x-4>*+* {
            margin-left: 1rem;
        }

        .space-y-1>*+* {
            margin-top: 0.25rem;
        }

        .space-y-3>*+* {
            margin-top: 0.75rem;
        }

        .pt-2 {
            padding-top: 0.5rem;
        }

        .px-3 {
            padding-left: 0.75rem;
            padding-right: 0.75rem;
        }

        .px-4 {
            padding-left: 1rem;
            padding-right: 1rem;
        }

        .py-2 {
            padding-top: 0.5rem;
            padding-bottom: 0.5rem;
        }

        .p-1 {
            padding: 0.25rem;
        }

        .p-2 {
            padding: 0.5rem;
        }

        .p-3 {
            padding: 0.75rem;
        }

        .p-5 {
            padding: 1.25rem;
        }

        .p-6 {
            padding: 1.5rem;
        }

        .p-8 {
            padding: 2rem;
        }

        .text-center {
            text-align: center;
        }

        /* LAYOUT AND DISPLAY */
        .flex {
            display: flex;
        }

        .hidden {
            display: none;
        }

        .items-center {
            align-items: center;
        }

        .justify-center {
            justify-content: center;
        }

        .justify-between {
            justify-content: space-between;
        }

        .flex-col {
            flex-direction: column;
        }

        .flex-1 {
            flex: 1 1 0%;
        }

        .block {
            display: block;
        }

        .inline-flex {
            display: inline-flex;
        }

        .grid {
            display: grid;
        }

        .gap-4 {
            gap: 1rem;
        }

        .gap-6 {
            gap: 1.5rem;
        }

        .rounded-md {
            border-radius: 0.375rem;
        }

        .rounded-lg {
            border-radius: 0.5rem;
        }

        .rounded-xl {
            border-radius: 0.75rem;
        }

        .rounded-full {
            border-radius: 9999px;
        }

        .rounded-l-md {
            border-top-left-radius: 0.375rem;
            border-bottom-left-radius: 0.375rem;
        }

        .rounded-r-md {
            border-top-right-radius: 0.375rem;
            border-bottom-right-radius: 0.375rem;
        }

        .w-full {
            width: 100%;
        }

        .w-5 {
            width: 1.25rem;
        }

        .w-6 {
            width: 1.5rem;
        }

        .w-8 {
            width: 2rem;
        }

        .w-20 {
            width: 5rem;
        }

        .h-4 {
            height: 1rem;
        }

        .h-5 {
            height: 1.25rem;
        }

        .h-6 {
            height: 1.5rem;
        }

        .h-8 {
            height: 2rem;
        }

        .h-20 {
            height: 5rem;
        }

        .shadow-sm {
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        }

        /* Adjusted shadow for better modern look */
        .shadow-md {
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
        }

        .shadow-lg {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
        }

        .shadow-inner {
            box-shadow: inset 0 2px 4px 0 rgba(0, 0, 0, 0.06);
        }

        .object-cover {
            object-fit: cover;
        }

        .border {
            border-width: 1px;
        }

        .border-l-4 {
            border-left-width: 4px;
        }

        .border-l-0 {
            border-left-width: 0px;
        }

        .border-gray-200 {
            border-color: #e5e7eb;
        }

        .border-gray-300 {
            border-color: #d1d5db;
        }

        .border-red-300 {
            border-color: #fca5a5;
        }

        .border-yellow-300 {
            border-color: #fcd34d;
        }

        .border-transparent {
            border-color: transparent;
        }

        .card {
            transition: all 0.2s ease-in-out;
            border: 1px solid #e9ecef;
        }

        /* Subtle border for card */
        .card:hover {
            transform: translateY(-1px);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.08);
        }


        /* TEXT AND COLORS (Poshakh Palette: Indigo/Navy and Gold/Mustard) */
        .text-xs {
            font-size: 0.75rem;
        }

        .text-sm {
            font-size: 0.875rem;
        }

        .text-base {
            font-size: 1rem;
        }

        .text-xl {
            font-size: 1.25rem;
        }

        .text-2xl {
            font-size: 1.5rem;
        }

        .text-3xl {
            font-size: 1.875rem;
        }

        .text-4xl {
            font-size: 2.25rem;
        }

        .text-gray-900 {
            color: #111827;
        }

        .text-gray-800 {
            color: #1f2937;
        }

        .text-gray-700 {
            color: #374151;
        }

        .text-gray-600 {
            color: #4b5563;
        }

        .text-gray-500 {
            color: #6c757d;
        }

        /* Darker gray for better contrast */
        .text-gray-400 {
            color: #9ca3af;
        }

        /* INDIGO/NAVY - PRIMARY COLOR */
        .text-indigo-800 {
            color: #1e3a8a;
        }

        /* Deep Indigo */
        .bg-indigo-100 {
            background-color: #e0e7ff;
        }

        .bg-indigo-800 {
            color: #1e3a8a;
        }

        /* ACCENT COLORS */
        .text-gold-600 {
            color: #D97706;
        }

        /* Gold/Mustard */
        .bg-gold-100 {
            background-color: #fff9e6;
        }

        .bg-gold-500 {
            background-color: #f59e0b;
        }

        .text-blue-500 {
            color: #4361ee;
        }

        /* Retained for link/system use */
        .text-white {
            color: #ffffff;
        }

        /* SUCCESS & WARNING COLORS */
        .text-green-600 {
            color: #059669;
        }

        .bg-green-100 {
            background-color: #d1fae5;
        }

        .bg-red-100 {
            background-color: #fee2e2;
        }

        .bg-red-500 {
            border-color: #ef4444;
        }

        /* NEUTRAL BACKGROUNDS */
        .bg-white {
            background-color: #ffffff;
        }

        .bg-gray-100 {
            background-color: #f8f9fa;
        }

        .bg-gray-200 {
            background-color: #e9ecef;
        }

        .bg-gray-300 {
            background-color: #d1d5db;
        }


        .font-bold {
            font-weight: 700;
        }

        .font-extrabold {
            font-weight: 800;
        }

        .font-medium {
            font-weight: 500;
        }

        .font-semibold {
            font-weight: 600;
        }

        .font-mono {
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
        }

        .opacity-80 {
            opacity: 0.8;
        }

        .uppercase {
            text-transform: uppercase;
        }

        /* INTERACTION & FORM */
        .cursor-not-allowed {
            cursor: not-allowed;
        }

        .focus\:ring-indigo-800:focus {
            --tw-ring-color: #1e3a8a;
            ring-width: 2px;
        }

        .focus\:border-indigo-800:focus {
            border-color: #1e3a8a;
        }

        /* Button Colors (Updated to Indigo and Gold) */
        .btn-primary {
            background-color: #1e3a8a;
            color: white;
        }

        .btn-primary:hover {
            background-color: #3730a3;
        }

        .btn-secondary {
            background-color: #D97706;
            color: white;
        }

        .btn-secondary:hover {
            background-color: #f59e0b;
        }

        /* Form Focus */
        .form-input-group input:focus,
        .form-input-group select:focus {
            border-color: #1e3a8a;
            box-shadow: 0 0 0 1px #1e3a8a;
            outline: none;
        }


        /* LOADING */
        .loading-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #1e3a8a;
            /* Indigo spinner */
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* RESPONSIVENESS */
        @media (min-width: 768px) {
            .md\:p-8 {
                padding: 2rem;
            }

            .md\:flex-row {
                flex-direction: row;
            }

            .md\:items-center {
                align-items: center;
            }

            .md\:mb-0 {
                margin-bottom: 0;
            }

            .md\:w-3\/5 {
                width: 60%;
            }

            .md\:w-2\/5 {
                width: 40%;
            }

            .md\:grid-cols-2 {
                grid-template-columns: repeat(2, minmax(0, 1fr));
            }

            .lg\:grid-cols-3 {
                grid-template-columns: repeat(3, minmax(0, 1fr));
            }

            .lg\:grid-cols-4 {
                grid-template-columns: repeat(4, minmax(0, 1fr));
            }

            /* Added 4-column grid */
            .col-span-1 {
                grid-column: span 1 / span 1;
            }

            .col-span-2 {
                grid-column: span 2 / span 2;
            }

            .col-span-3 {
                grid-column: span 3 / span 3;
            }

            .col-span-4 {
                grid-column: span 4 / span 4;
            }
        }
    </style>
</head>

<body>
    <div id="root">
        <div class="loading-container">
            <div class="spinner mr-3"></div>
            <div class="text-xl font-medium text-blue-500">Loading Application...</div>
        </div>
    </div>

    <!-- ---------------------------------------------------- -->
    <!-- FIREBASE AND REACT SCRIPTS -->
    <!-- ---------------------------------------------------- -->

    <!-- Firebase SDKs are loaded from CDN for Auth and Firestore -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, doc, setDoc, deleteDoc, query, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Expose Firebase modules to the global window object for the Babel script to use
        window.firebase = {
            initializeApp, getAuth, signInAnonymously, onAuthStateChanged,
            getFirestore, collection, onSnapshot, doc, setDoc, deleteDoc, query, addDoc, serverTimestamp
        };
        window.FIREBASE_MODULES_LOADED = true;
    </script>

    <!-- React and Babel for JSX in browser -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script type="text/babel">
        // ----------------------------------------------------
        // FIREBASE CONFIGURATION (INJECTED)
        // ----------------------------------------------------
        const FIREBASE_CONFIG = {
            // UPDATED KEYS FOR NEW PROJECT: poshakh-fabric-final
            apiKey: "AIzaSyA-iTofFK-Y1QZtmVs-yzpEWiEzyfBHuu4",
            authDomain: "poshakh-fabric-final.firebaseapp.com",
            projectId: "poshakh-fabric-final",
            storageBucket: "poshakh-fabric-final.firebasestorage.app",
            messagingSenderId: "3725988553447",
            appId: "1:372598853447:web:5d177d6bdc5066c02c0662"
        };

        // --- Firestore Collection Path ---
        // Shared public path for all teams accessing the app
        const COLLECTION_PATH = 'artifacts/poshakh-fabric-manager/public/data/fabrics';
        const APP_ID = 'poshakh-fabric-manager'; // Used for the artifacts path

        // Icons (simplified from lucide-react for single-file HTML)
        const Plus = (props) => <svg {...props} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>;
        const Trash2 = (props) => <svg {...props} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6"></path><path d="M10 11v6"></path><path d="M14 11v6"></path><path d="M5 6L6 6L6 6"></path><line x1="15" y1="3" x2="9" y2="3"></line></svg>;
        const Gauge = (props) => <svg {...props} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12 14v4"></path><path d="M8.5 13.5l1 1"></path><path d="M15.5 13.5l-1 1"></path><path d="M12 2a10 10 0 1 0 10 10A10 10 0 0 0 12 2z"></path></svg>;
        const Ruler = (props) => <svg {...props} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M16 12L12 16L8 12"></path><path d="M4 4h16v16H4z"></path></svg>;
        const Shirt = (props) => <svg {...props} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M20.5 4.5l-2.5 7h-11l-2.5-7"></path><path d="M22 10l-2 10"></path><path d="M2 10l2 10"></path><path d="M12 2l4 2.5v2.5H8V4.5z"></path></svg>;
        const Camera = (props) => <svg {...props} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path><circle cx="12" cy="13" r="4"></circle></svg>;
        const ImageIcon = (props) => <svg {...props} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><polyline points="21 15 16 10 5 21"></polyline></svg>;
        const DollarSign = (props) => <svg {...props} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="12" y1="1" x2="12" y2="23"></line><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path></svg>;
        const Hash = (props) => <svg {...props} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="4" y1="9" x2="20" y2="9"></line><line x1="4" y1="15" x2="20" y2="15"></line><line x1="10" y1="3" x2="8" y2="21"></line><line x1="16" y1="3" x2="14" y2="21"></line></svg>;
        const User = (props) => <svg {...props} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>;
        const Tag = (props) => <svg {...props} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M20.5 4.5l-2.5 7h-11l-2.5-7"></path><path d="M22 10l-2 10"></path><path d="M2 10l2 10"></path><path d="M12 2l4 2.5v2.5H8V4.5z"></path></svg>;
        const Scissors = (props) => <svg {...props} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="6" cy="6" r="3"></circle><circle cx="6" cy="18" r="3"></circle><line x1="20" y1="4" x2="8.12" y2="15.88"></line><line x1="14.47" y1="14.48" x2="20" y2="20"></line><line x1="8.12" y1="8.12" x2="12" y2="12"></line></svg>;
        const Clock = (props) => <svg {...props} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>;
        const ChevronRight = (props) => <svg {...props} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="9 18 15 12 9 6"></polyline></svg>;
        const ChevronDown = (props) => <svg {...props} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg>;


        // --- CONSTANTS ---
        const MAX_FILE_SIZE_BYTES = 750 * 1024; // 750KB limit

        // Helper function to generate a unique ID
        const generateId = () => Date.now().toString(36) + Math.random().toString(36).substring(2);

        // Helper function to convert a File object to a Base64 string
        const fileToBase64 = (file) => new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = () => resolve(reader.result);
            reader.onerror = (error) => reject(error);
        });

        // Helper function to calculate byte size from Base64 Data URL
        const getBase64ByteSize = (dataUrl) => {
            if (!dataUrl) return 0;
            const base64String = dataUrl.split(',')[1];
            return Math.ceil(base64String.length * 3 / 4);
        };

        const App = () => {
            const { useState, useEffect, useMemo, useRef } = React;
            const { collection, doc, setDoc, deleteDoc, query, onSnapshot, addDoc, serverTimestamp } = window.firebase;

            const [db, setDb] = useState(null);
            const [auth, setAuth] = useState(null);
            const [userId, setUserId] = useState(null);
            const [fabrics, setFabrics] = useState([]);
            const [loading, setLoading] = useState(true);
            const [fatalError, setFatalError] = useState(null); // For connection/auth failures
            const [operationalError, setOperationalError] = useState(null); // For form/CRUD failures
            const [isUploading, setIsUploading] = useState(false);
            const [userEmail, setUserEmail] = useState('Anonymous User');

            // Refs for hidden file inputs
            const cameraInputRef = useRef(null);
            const galleryInputRef = useRef(null);

            // Form State
            const [newFabric, setNewFabric] = useState({
                name: '',
                totalLength: '',
                unit: 'meters',
                lengthRequiredPerOutfit: '',
                costPerMeter: '', // NEW FIELD
            });
            const [newFabricImageFile, setNewFabricImageFile] = useState(null);

            // State for updating current stock
            const [updateFabricId, setUpdateFabricId] = useState(null);
            const [updateAmountUsed, setUpdateAmountUsed] = useState('');
            // NEW TRACKING FIELDS
            const [updateOrderNumber, setUpdateOrderNumber] = useState('');
            const [updateProductName, setUpdateProductName] = useState('');
            const [updateSize, setUpdateSize] = useState('');
            const [updateCustomerName, setUpdateCustomerName] = useState('');

            // State for viewing history
            const [historyFabricId, setHistoryFabricId] = useState(null);
            const [transactionHistory, setTransactionHistory] = useState([]);
            const [expandedTransactionId, setExpandedTransactionId] = useState(null);

            // ------------------------------------
            // 1. FIREBASE INITIALIZATION & ANONYMOUS AUTH
            // ------------------------------------

            useEffect(() => {
                // Ensure Firebase modules are loaded before initializing
                if (!window.FIREBASE_MODULES_LOADED) {
                    const timer = setTimeout(() => {
                        if (!window.FIREBASE_MODULES_LOADED) {
                            setFatalError("Firebase modules failed to load.");
                            setLoading(false);
                        }
                    }, 5000); // 5 second timeout
                    return () => clearTimeout(timer);
                }

                try {
                    const { initializeApp, getFirestore, getAuth, onAuthStateChanged, signInAnonymously } = window.firebase;

                    const app = initializeApp(FIREBASE_CONFIG);
                    const firestore = getFirestore(app);
                    const firebaseAuth = getAuth(app);

                    setDb(firestore);
                    setAuth(firebaseAuth);

                    // Anonymous Sign-in for shared access without login screen
                    signInAnonymously(firebaseAuth).catch(err => {
                        console.error("Anonymous Sign-in failed:", err);
                        setFatalError(`Authentication Failed: ${err.code}. Check Firebase Console for 'Anonymous' sign-in status.`);
                        setLoading(false);
                    });

                    // Set up Auth State Listener
                    const unsubscribeAuth = onAuthStateChanged(firebaseAuth, (user) => {
                        if (user) {
                            setUserId(user.uid);
                            // Anonymous users don't have an email, so we use their UID
                            setUserEmail(user.email || `Anon-${user.uid.substring(0, 8)}`);
                            setLoading(false);
                        } else {
                            // Should not happen after successful signInAnonymously
                            setUserId(null);
                            setLoading(false);
                        }
                    });

                    return () => unsubscribeAuth();
                } catch (e) {
                    console.error("Firebase Initialization Error:", e);
                    setFatalError("Could not initialize Firebase. Check API keys and network connection.");
                    setLoading(false);
                }
            }, []);

            // ------------------------------------
            // 2. DATA LISTENER (FIRESTORE)
            // ------------------------------------

            useEffect(() => {
                if (!db || !userId) return;

                // Set up real-time listener for the shared collection
                try {
                    const fabricCollectionRef = collection(db, COLLECTION_PATH);
                    const q = query(fabricCollectionRef);

                    const unsubscribe = onSnapshot(q, (snapshot) => {
                        const fabricList = snapshot.docs.map(doc => {
                            const data = doc.data();
                            const currentLength = parseFloat(data.currentLength) || 0;
                            const lengthRequiredPerOutfit = parseFloat(data.lengthRequiredPerOutfit) || 1;
                            const costPerMeter = parseFloat(data.costPerMeter) || 0;

                            const potentialOutfits = Math.floor(currentLength / lengthRequiredPerOutfit);
                            const totalCurrentCost = currentLength * costPerMeter; // NEW CALCULATION

                            return {
                                id: doc.id,
                                ...data,
                                currentLength,
                                lengthRequiredPerOutfit,
                                costPerMeter, // Ensure cost is present
                                potentialOutfits,
                                totalCurrentCost // NEW DERIVED FIELD
                            };
                        });
                        setFabrics(fabricList);
                    }, (err) => {
                        console.error("Firestore Listener Error:", err);
                        setOperationalError("Failed to fetch real-time data from Firestore. Check security rules.");
                    });

                    return () => unsubscribe();
                } catch (e) {
                    console.error("Firestore Query Error:", e);
                }
            }, [db, userId]);

            // ------------------------------------
            // 3. TRANSACTION HISTORY LISTENER
            // ------------------------------------
            useEffect(() => {
                if (!db || !historyFabricId) {
                    setTransactionHistory([]);
                    return;
                }

                try {
                    // Path to the subcollection: fabrics/{fabricId}/history
                    const historyCollectionPath = `${COLLECTION_PATH}/${historyFabricId}/history`;
                    const historyCollectionRef = collection(db, historyCollectionPath);
                    const q = query(historyCollectionRef);

                    const unsubscribeHistory = onSnapshot(q, (snapshot) => {
                        const historyList = snapshot.docs.map(doc => ({
                            id: doc.id,
                            ...doc.data()
                        })).sort((a, b) => b.updatedAt - a.updatedAt); // Sort newest first

                        setTransactionHistory(historyList);
                    }, (err) => {
                        console.error("History Listener Error:", err);
                        setOperationalError(`Failed to load history for ${historyFabricId}.`);
                    });

                    return () => unsubscribeHistory();
                } catch (e) {
                    console.error("History Query Error:", e);
                }
            }, [db, historyFabricId]);



            // ------------------------------------
            // 4. CRUD FUNCTIONS (FIRESTORE)
            // ------------------------------------

            // Handler for file selection from input
            const handleFileChange = (e) => {
                const file = e.target.files[0];
                if (file) {
                    setNewFabricImageFile(file);
                }
                e.target.value = null; // Reset input field
            };

            const resetFormAndState = () => {
                setNewFabric({ name: '', totalLength: '', unit: 'meters', lengthRequiredPerOutfit: '', costPerMeter: '' }); // RESET NEW FIELD
                setNewFabricImageFile(null);
                setOperationalError(null);
            }

            const handleAddFabric = async (e) => {
                e.preventDefault();
                if (!db || !userId) return;

                const { name, totalLength, unit, lengthRequiredPerOutfit, costPerMeter } = newFabric; // NEW FIELD DESTRUCTURED
                let imageUrlToStore = '';

                if (!name || !totalLength || !lengthRequiredPerOutfit || !costPerMeter) {
                    setOperationalError("Please fill in ALL required fields (Name, Length, Required Length, and Cost per Meter).");
                    return;
                }

                // Clear any previous error before trying again
                setOperationalError(null);
                setIsUploading(true); // START UPLOADING

                try {
                    if (newFabricImageFile) {
                        const rawDataUrl = await fileToBase64(newFabricImageFile);
                        const sizeInBytes = getBase64ByteSize(rawDataUrl);

                        if (sizeInBytes > MAX_FILE_SIZE_BYTES) {
                            setOperationalError(`Image is too large (${(sizeInBytes / 1024).toFixed(0)}KB). The limit is 750 KB.`);
                            return;
                        }
                        imageUrlToStore = rawDataUrl;
                    } else {
                        // Generate placeholder image
                        const placeholderText = name.substring(0, 2).toUpperCase() || 'FAB';
                        imageUrlToStore = `https://placehold.co/100x100/1E3A8A/ffffff?text=${placeholderText}`;
                    }

                    // --- Input Validation and Data Preparation ---
                    const currentLengthFloat = parseFloat(totalLength) || 0;
                    const lengthRequiredPerOutfitFloat = parseFloat(lengthRequiredPerOutfit) || 0;
                    const costPerMeterFloat = parseFloat(costPerMeter) || 0; // NEW FIELD PARSED

                    if (currentLengthFloat <= 0 || lengthRequiredPerOutfitFloat <= 0 || costPerMeterFloat < 0) {
                        setOperationalError("Length and Cost must be valid positive numbers.");
                        return; // Exit here
                    }

                    const newDoc = {
                        name,
                        totalLength: currentLengthFloat,
                        currentLength: currentLengthFloat,
                        unit,
                        lengthRequiredPerOutfit: lengthRequiredPerOutfitFloat,
                        costPerMeter: costPerMeterFloat, // NEW FIELD SAVED
                        imageUrl: imageUrlToStore,
                        updatedByEmail: userEmail,
                        updatedAt: serverTimestamp(),
                        createdAt: serverTimestamp(),
                    };

                    const fabricCollectionRef = collection(db, COLLECTION_PATH);
                    // DATABASE COMMIT
                    await setDoc(doc(fabricCollectionRef), newDoc);

                    // SUCCESS PATH: Call the consolidated reset function
                    resetFormAndState();

                } catch (e) {
                    console.error("Error adding document: ", e);
                    setOperationalError(`Failed to add new fabric stock: ${e.message}. Check Firestore Security Rules!`);
                } finally {
                    // THE NEW, DEFINITIVE RESET: This runs after success OR failure
                    setIsUploading(false);
                }
            };

            const handleDeleteFabric = async (id) => {
                if (!db || !userId) return;

                // NOTE: Deleting the main document does NOT automatically delete subcollections (history).
                // For this single-file app, we rely on Firebase rules or manual cleanup later.

                try {
                    const docRef = doc(db, COLLECTION_PATH, id);
                    await deleteDoc(docRef);
                    setOperationalError(null);
                } catch (e) {
                    console.error("Error deleting document: ", e);
                    setOperationalError(`Failed to delete fabric entry: ${e.message}. Check Security Rules.`);
                }
            };

            const handleUpdateStock = async (e) => {
                e.preventDefault();
                if (!db || !userId || !updateFabricId || !updateAmountUsed) return;

                const amountUsed = parseFloat(updateAmountUsed);
                if (isNaN(amountUsed) || amountUsed <= 0) {
                    setOperationalError("Please enter a valid amount of fabric used (a positive number).");
                    return;
                }

                const fabric = fabrics.find(f => f.id === updateFabricId);
                if (!fabric) return;

                const newCurrentLength = fabric.currentLength - amountUsed;

                if (newCurrentLength < 0) {
                    setOperationalError(`Cannot use ${amountUsed} ${fabric.unit}. Only ${fabric.currentLength.toFixed(2)} ${fabric.unit} remaining.`);
                    return;
                }

                try {
                    const fabricDocRef = doc(db, COLLECTION_PATH, updateFabricId);

                    // 1. ADD NEW TRANSACTION TO SUBCOLLECTION (HISTORY)
                    const historyCollectionRef = collection(fabricDocRef, 'history');

                    const transactionData = {
                        amountUsed: amountUsed,
                        orderNumber: updateOrderNumber || 'N/A',
                        productName: updateProductName || 'N/A',
                        size: updateSize || 'N/A',
                        customerName: updateCustomerName || 'N/A',
                        usedByEmail: userEmail,
                        usedAt: serverTimestamp(),
                    };

                    await addDoc(historyCollectionRef, transactionData);

                    // 2. UPDATE MAIN DOCUMENT (CURRENT LENGTH)
                    const updateData = {
                        currentLength: newCurrentLength,
                        // Set the current transaction details as the "last used" summary in the main document
                        lastOrderNumber: transactionData.orderNumber,
                        lastProductName: transactionData.productName,
                        lastCustomerName: transactionData.customerName,
                        lastAmountUsed: transactionData.amountUsed,
                        updatedByEmail: userEmail,
                        updatedAt: serverTimestamp(),
                    };

                    await setDoc(fabricDocRef, updateData, { merge: true });

                    // Clear update form states and switch back to viewing history
                    setUpdateFabricId(null);
                    setUpdateAmountUsed('');
                    setUpdateOrderNumber('');
                    setUpdateProductName('');
                    setUpdateSize('');
                    setUpdateCustomerName('');
                    setOperationalError(null);
                    setHistoryFabricId(fabric.id); // Automatically open history view after successful update

                } catch (e) {
                    console.error("Error updating stock and history: ", e);
                    setOperationalError(`Failed to update stock and log history: ${e.message}. Check Security Rules.`);
                }
            };

            // Toggle history view
            const toggleHistory = (fabricId) => {
                setHistoryFabricId(historyFabricId === fabricId ? null : fabricId);
                setExpandedTransactionId(null); // Close any expanded transaction when changing fabrics
            };

            const toggleTransactionDetails = (transactionId) => {
                setExpandedTransactionId(expandedTransactionId === transactionId ? null : transactionId);
            };

            // ------------------------------------
            // 5. DERIVED STATE & UI RENDERING
            // ------------------------------------

            const totalPotentialOutfits = useMemo(() => {
                return fabrics.reduce((sum, f) => sum + f.potentialOutfits, 0);
            }, [fabrics]);

            const totalInventoryValue = useMemo(() => {
                // Sum the calculated cost of all remaining stock items
                const total = fabrics.reduce((sum, f) => sum + f.totalCurrentCost, 0);
                return total.toFixed(2);
            }, [fabrics]);

            // Format Firestore Timestamp for display
            const formatTimestamp = (timestamp, timeOnly = false) => {
                if (timestamp && timestamp.toDate) {
                    const date = timestamp.toDate();
                    if (timeOnly) {
                        return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                    }
                    return date.toLocaleDateString('en-IN', { year: 'numeric', month: 'short', day: 'numeric' });
                }
                return 'N/A';
            };


            if (fatalError) {
                return (
                    <div className="p-8 bg-red-100 border-l-4 border-red-500 text-red-700 min-h-screen">
                        <p className="font-bold">FATAL APPLICATION ERROR</p>
                        <p>{fatalError}</p>
                        <p className="mt-2 text-sm text-gray-600">Please check your Firebase Console settings (Authentication & API Keys).</p>
                    </div>
                );
            }

            if (loading || !userId) {
                return (
                    <div className="flex items-center justify-center min-h-screen bg-gray-50">
                        <div className="spinner mr-3"></div>
                        <div className="text-xl font-medium text-blue-500">Connecting to Shared Database...</div>
                    </div>
                );
            }

            return (
                <div className="p-4 md:p-8 bg-gray-50 min-h-screen font-sans">
                    <div className="max-w-6xl mx-auto">
                        <h1 className="text-4xl font-extrabold text-gray-900 mb-2">Fabric Stock Manager</h1>
                        <p className="text-sm text-gray-500 mb-6">
                            User ID: <span className="font-mono bg-gray-200 p-1 rounded-md text-xs">{userEmail}</span>
                        </p>
                        <p className="text-sm text-green-700 mb-6 bg-green-100 p-2 rounded-lg border border-red-300 font-semibold">
                            This version is **Shared and Live**. All updates are synchronized in real-time on your Firebase project.
                        </p>

                        {/* Operational Error Display */}
                        {operationalError && (
                            <div className="p-3 mb-6 bg-red-100 border-l-4 border-red-500 text-red-700 rounded-md">
                                <p className="font-bold">Action Failed</p>
                                <p className="text-sm">{operationalError}</p>
                                <button onClick={() => setOperationalError(null)} className="text-xs text-red-600 font-medium mt-1">Dismiss</button>
                            </div>
                        )}

                        {/* Global Stats */}
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
                            {/* Total Fabrics Card (Indigo Theme) */}
                            <div className="card btn-primary text-white p-6 rounded-xl shadow-lg flex items-center">
                                <Gauge className="w-8 h-8 mr-4" />

                                <div>
                                    <p className="text-sm opacity-80 uppercase font-semibold">Total Fabric SKUs</p>
                                    <p className="text-3xl font-bold">{fabrics.length}</p>
                                </div>
                            </div>
                            {/* Total Potential Outfits Card (Gold/Mustard Theme) */}
                            <div className="card btn-secondary text-white p-6 rounded-xl shadow-lg flex items-center">
                                <Shirt className="w-8 h-8 mr-4" />
                                <div>
                                    <p className="text-sm opacity-80 uppercase font-semibold">Total Potential Outfits</p>
                                    <p className="text-3xl font-bold">{totalPotentialOutfits}</p>
                                </div>
                            </div>
                            {/* Total Inventory Value Card (Green/Success Theme) */}
                            <div className="card bg-green-600 text-white p-6 rounded-xl shadow-lg flex items-center col-span-1 md:col-span-2 lg:col-span-2">
                                <DollarSign className="w-8 h-8 mr-4" />
                                <div>
                                    <p className="text-sm opacity-80 uppercase font-semibold">Total Inventory Value (Cost)</p>
                                    <p className="text-3xl font-bold">₹ {totalInventoryValue}</p>
                                </div>
                            </div>
                        </div>

                        {/* Add New Fabric Section */}
                        <div className="card bg-white p-6 rounded-xl shadow-lg mb-8">
                            <h2 className="text-2xl font-semibold text-gray-800 mb-4 flex items-center"><Plus className="w-5 h-5 mr-2" /> Add New Fabric Stock</h2>
                            <form onSubmit={handleAddFabric} className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">

                                {/* 1. Fabric Name */}
                                <div className="form-input-group">
                                    <label className="block text-sm font-medium text-gray-700">Fabric Name</label>
                                    <input
                                        type="text"
                                        required
                                        className="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border focus:ring-blue-500 focus:border-border-blue-500"
                                        value={newFabric.name}
                                        onChange={(e) => setNewFabric({ ...newFabric, name: e.target.value })}
                                    />
                                </div>

                                {/* 2. Total Length */}
                                <div className="form-input-group">
                                    <label className="block text-sm font-medium text-gray-700">Total Length in Stock</label>
                                    <div className="mt-1 flex rounded-md shadow-sm">
                                        <input
                                            type="number"
                                            step="0.01"
                                            min="0.1"
                                            required
                                            className="flex-1 block w-full rounded-l-md border-gray-300 p-2 border focus:ring-blue-500 focus:border-blue-500"
                                            value={newFabric.totalLength}
                                            onChange={(e) => setNewFabric({ ...newFabric, totalLength: e.target.value })}
                                        />
                                        <select
                                            className="inline-flex items-center px-3 rounded-r-md border border-l-0 border-gray-300 bg-gray-50 text-gray-500 text-sm"
                                            value={newFabric.unit}
                                            onChange={(e) => setNewFabric({ ...newFabric, unit: e.target.value })}
                                        >
                                            <option value="meters">meters</option>
                                            <option value="yards">yards</option>
                                        </select>
                                    </div>
                                </div>

                                {/* 3. Cost Per Meter (NEW INPUT) */}
                                <div className="form-input-group">
                                    <label className="block text-sm font-medium text-gray-700">Cost per Meter (₹)</label>
                                    <input
                                        type="number"
                                        step="0.01"
                                        min="0"
                                        required
                                        className="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border focus:ring-blue-500 focus:border-blue-500"
                                        value={newFabric.costPerMeter}
                                        onChange={(e) => setNewFabric({ ...newFabric, costPerMeter: e.target.value })}
                                    />
                                </div>


                                {/* 4. Length Required Per Outfit */}
                                <div className="form-input-group">
                                    <label className="block text-sm font-medium text-gray-700">Length Required per Outfit</label>
                                    <input
                                        type="number"
                                        step="0.01"
                                        min="0.1"
                                        required
                                        className="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border focus:ring-blue-500 focus:border-blue-500"
                                        value={newFabric.lengthRequiredPerOutfit}
                                        onChange={(e) => setNewFabric({ ...newFabric, lengthRequiredPerOutfit: e.target.value })}
                                    />
                                    <p className="mt-1 text-xs text-gray-500">Meters to make one average outfit.</p>
                                </div>

                                {/* Image Capture / Gallery Buttons (Spans full width) */}
                                <div className="lg:col-span-4 md:col-span-2 form-input-group">
                                    <label className="block text-sm font-medium text-gray-700 mb-2">Fabric Image (Choose Option)</label>
                                    <div className="flex space-x-4">
                                        {/* Hidden input for camera */}
                                        <input
                                            type="file"
                                            accept="image/*"
                                            capture="environment"
                                            ref={cameraInputRef}
                                            onChange={handleFileChange}
                                            className="hidden"
                                        />
                                        {/* Button to trigger camera */}
                                        <button
                                            type="button"
                                            onClick={() => cameraInputRef.current.click()}
                                            className="flex flex-col items-center justify-center p-3 w-32 h-20 bg-indigo-100 text-indigo-800 rounded-lg shadow-md hover:bg-indigo-200 transition duration-150"
                                        >
                                            <Camera className="w-6 h-6" />
                                            <span className="text-xs mt-1">Take Photo</span>
                                        </button>

                                        {/* Hidden input for gallery */}
                                        <input
                                            type="file"
                                            accept="image/*"
                                            ref={galleryInputRef}
                                            onChange={handleFileChange}
                                            className="hidden"
                                        />
                                        {/* Button to trigger gallery */}
                                        <button
                                            type="button"
                                            onClick={() => galleryInputRef.current.click()}
                                            className="flex flex-col items-center justify-center p-3 w-32 h-20 bg-gold-100 text-indigo-800 rounded-lg shadow-md hover:bg-gray-200 transition duration-150"
                                        >
                                            <ImageIcon className="w-6 h-6" />
                                            <span className="text-xs mt-1">Upload from Gallery</span>
                                        </button>
                                        <div className="flex flex-col justify-center ml-4">
                                            {newFabricImageFile && (
                                                <p className="text-xs text-green-600 font-semibold">
                                                    File selected: {newFabricImageFile.name}
                                                    {(newFabricImageFile.size / 1024).toFixed(0) > 750 ?
                                                        <span className="text-red-600 font-bold ml-2"> (Too Large! Limit 750 KB)</span> : ''
                                                    }
                                                </p>
                                            )}
                                        </div>
                                    </div>

                                    <p className="mt-1 text-xs text-gray-500">
                                        Images are stored in Firebase documents as a Base64 string (Max 750 KB).
                                    </p>
                                </div>

                                {/* Submit Button (Spans full width) */}
                                <div className="lg:col-span-4 md:col-span-2 pt-2 form-input-group">
                                    <button
                                        type="submit"
                                        disabled={isUploading || !db}
                                        className={`w-full justify-center inline-flex items-center px-4 py-2 border border-transparent rounded-md shadow-sm text-base font-medium text-white transition duration-150 ${isUploading ? 'bg-gray-500 cursor-not-allowed' : 'btn-primary'}`}
                                    >
                                        {isUploading ? (
                                            <>
                                                <span className="spinner mr-2"></span> Uploading...
                                            </>
                                        ) : (
                                            <>
                                                <Plus className="w-5 h-5 mr-2" /> Add Fabric to Stock
                                            </>
                                        )}
                                    </button>
                                </div>
                            </form>
                        </div>

                        {/* Current Stock List */}
                        <h2 className="text-3xl font-bold text-gray-900 mb-6">Current Fabric Stock ({fabrics.length} items)</h2>

                        {fabrics.length === 0 ? (
                            <div className="p-8 text-center bg-white rounded-xl shadow-lg text-gray-500">No fabric stock recorded yet. Use the form above to add an item!</div>
                        ) : (
                            <div className="grid grid-cols-1 gap-6">
                                {fabrics.map((fabric) => (
                                    <div key={fabric.id} className="card bg-white p-5 rounded-xl shadow-md flex flex-col space-y-4">

                                        {/* Main Item Row */}
                                        <div className="flex flex-col md:flex-row justify-between items-start md:items-center">
                                            <div className="flex items-center mb-4 md:mb-0 w-full md:w-3/5">
                                                {/* Image Placeholder/Display */}
                                                <img
                                                    src={fabric.imageUrl}
                                                    alt={fabric.name}
                                                    className="w-20 h-20 object-cover rounded-lg shadow-inner mr-4 border border-gray-200"
                                                    onError={(e) => {
                                                        e.target.onerror = null;
                                                        e.target.src = `https://placehold.co/80x80/1E3A8A/ffffff?text=${(fabric.name || 'FAB').substring(0, 3).toUpperCase()}`;
                                                    }}
                                                />
                                                {/* Fabric Details */}
                                                <div>
                                                    <h3 className="text-xl font-bold text-gray-900">{fabric.name}</h3>
                                                    <div className="text-sm text-gray-600 space-y-1 mt-1">
                                                        <p className="flex items-center"><Ruler className="w-4 h-4 mr-2 text-indigo-800" /> Stock: {fabric.currentLength.toFixed(2)} {fabric.unit}</p>
                                                        <p className="flex items-center"><Shirt className="w-4 h-4 mr-2 text-gold-600" /> Req. per Outfit: {fabric.lengthRequiredPerOutfit.toFixed(2)} {fabric.unit}</p>
                                                        <p className="flex items-center text-green-600"><DollarSign className="w-4 h-4 mr-2" /> Current Cost: ₹ {fabric.totalCurrentCost.toFixed(2)}</p>
                                                    </div>
                                                    <p className="text-xs text-gray-400 mt-2">
                                                        Last updated:
                                                        <span className="font-semibold text-gray-600 ml-1">{formatTimestamp(fabric.updatedAt)}</span> by
                                                        <span className="font-semibold text-gray-600 ml-1">{fabric.updatedByEmail || 'N/A'}</span>
                                                    </p>
                                                </div>
                                            </div>

                                            {/* Stock & Calculation */}
                                            <div className="w-full md:w-2/5 flex flex-col space-y-3">
                                                <div className="flex justify-between items-center bg-gray-100 p-3 rounded-lg">
                                                    <div>
                                                        <p className="text-sm font-medium text-gray-500">Remaining Stock</p>
                                                        <p className="text-2xl font-extrabold text-indigo-800">
                                                            {fabric.currentLength.toFixed(2)} {fabric.unit}
                                                        </p>
                                                    </div>
                                                    <div>
                                                        <p className="text-sm font-medium text-gray-500">Potential Outfits</p>
                                                        <p className="text-2xl font-extrabold text-gold-600">
                                                            {fabric.potentialOutfits}
                                                        </p>
                                                    </div>
                                                </div>

                                                {/* Action Buttons */}
                                                <div className="flex space-x-2">
                                                    <button
                                                        onClick={() => toggleHistory(fabric.id)}
                                                        className={`flex-1 px-4 py-2 rounded-md font-medium transition duration-150 shadow-md flex items-center justify-center ${historyFabricId === fabric.id ? 'bg-indigo-600 text-white' : 'bg-gray-200 text-gray-800 hover:bg-gray-300'}`}
                                                    >
                                                        {historyFabricId === fabric.id ? 'Hide History' : 'View History'}
                                                    </button>

                                                    <button
                                                        onClick={() => {
                                                            setUpdateFabricId(fabric.id);
                                                            setHistoryFabricId(null); // Hide history when updating
                                                        }}
                                                        className={`flex-1 btn-secondary text-gray-900 px-4 py-2 rounded-md font-medium transition duration-150 shadow-md ${updateFabricId === fabric.id ? 'bg-gray-400' : ''}`}
                                                        disabled={updateFabricId === fabric.id}
                                                    >
                                                        Update Stock
                                                    </button>
                                                    <button
                                                        onClick={() => handleDeleteFabric(fabric.id)}
                                                        className="p-3 bg-red-100 text-red-600 rounded-md hover:bg-red-200 transition duration-150"
                                                        title="Delete Fabric Entry"
                                                    >
                                                        <Trash2 className="w-5 h-5" />
                                                    </button>
                                                </div>
                                            </div>
                                        </div>

                                        {/* History View or Update Form Container */}
                                        {updateFabricId === fabric.id && (
                                            <div className="w-full pt-4 border-t border-gray-200 mt-4">
                                                <h4 className="text-lg font-semibold text-gray-700 mb-3 flex items-center"><Scissors className="w-5 h-5 mr-2 text-gold-600" /> Log Stock Reduction</h4>
                                                <form onSubmit={handleUpdateStock} className="grid grid-cols-1 md:grid-cols-2 gap-4">

                                                    {/* Row 1: Amount Used */}
                                                    <div className="md:col-span-2 form-input-group">
                                                        <label className="block text-sm font-medium text-gray-700">Amount Used ({fabric.unit})</label>
                                                        <input
                                                            type="number"
                                                            step="0.01"
                                                            min="0.01"
                                                            required
                                                            placeholder={`Enter amount used (e.g., ${fabric.lengthRequiredPerOutfit.toFixed(2)})`}
                                                            className="w-full p-2 border border-yellow-300 rounded-md shadow-sm focus:ring-yellow-500 focus:border-yellow-500"
                                                            value={updateAmountUsed}
                                                            onChange={(e) => setUpdateAmountUsed(e.target.value)}
                                                        />
                                                    </div>

                                                    {/* Row 2: Order Details */}
                                                    <div className="form-input-group">
                                                        <label className="block text-sm font-medium text-gray-700 flex items-center"><Hash className="w-4 h-4 mr-1" /> Order Number</label>
                                                        <input
                                                            type="text"
                                                            placeholder="Order # (e.g., 1002)"
                                                            className="w-full p-2 border border-gray-300 rounded-md shadow-sm"
                                                            value={updateOrderNumber}
                                                            onChange={(e) => setUpdateOrderNumber(e.target.value)}
                                                        />
                                                    </div>
                                                    <div className="form-input-group">
                                                        <label className="block text-sm font-medium text-gray-700 flex items-center"><User className="w-4 h-4 mr-1" /> Customer Name</label>
                                                        <input
                                                            type="text"
                                                            placeholder="Customer Name"
                                                            className="w-full p-2 border border-gray-300 rounded-md shadow-sm"
                                                            value={updateCustomerName}
                                                            onChange={(e) => setUpdateCustomerName(e.target.value)}
                                                        />
                                                    </div>

                                                    {/* Row 3: Product Details */}
                                                    <div className="form-input-group">
                                                        <label className="block text-sm font-medium text-gray-700 flex items-center"><Tag className="w-4 h-4 mr-1" /> Product Name</label>
                                                        <input
                                                            type="text"
                                                            placeholder="Product (e.g., Blazer)"
                                                            className="w-full p-2 border border-gray-300 rounded-md shadow-sm"
                                                            value={updateProductName}
                                                            onChange={(e) => setUpdateProductName(e.target.value)}
                                                        />
                                                    </div>
                                                    <div className="form-input-group">
                                                        <label className="block text-sm font-medium text-gray-700">Size/Notes</label>
                                                        <input
                                                            type="text"
                                                            placeholder="Size (e.g., L) or specific notes"
                                                            className="w-full p-2 border border-gray-300 rounded-md shadow-sm"
                                                            value={updateSize}
                                                            onChange={(e) => setUpdateSize(e.target.value)}
                                                        />
                                                    </div>

                                                    {/* Action Buttons */}
                                                    <div className="md:col-span-2 flex space-x-2 mt-3">
                                                        <button
                                                            type="submit"
                                                            className="flex-1 btn-secondary text-gray-900 px-4 py-2 rounded-md font-medium transition duration-150"
                                                        >
                                                            Update Stock
                                                        </button>
                                                        <button
                                                            type="button"
                                                            onClick={() => {
                                                                setUpdateFabricId(null);
                                                                setUpdateAmountUsed('');
                                                                setUpdateOrderNumber('');
                                                                setUpdateProductName('');
                                                                setUpdateSize('');
                                                                setUpdateCustomerName('');
                                                                setOperationalError(null);
                                                            }}
                                                            className="bg-gray-300 text-gray-800 px-3 py-2 rounded-md font-medium hover:bg-gray-400 transition duration-150"
                                                        >
                                                            Cancel
                                                        </button>
                                                    </div>
                                                </form>
                                            </div>
                                        )}

                                        {/* Transaction History Section */}
                                        {historyFabricId === fabric.id && (
                                            <div className="w-full pt-4 border-t border-gray-200 mt-4 bg-gray-50 rounded-lg p-3">
                                                <h4 className="text-lg font-semibold text-gray-700 mb-3 flex items-center"><Clock className="w-5 h-5 mr-2 text-indigo-800" /> Usage History ({transactionHistory.length} logs)</h4>

                                                {transactionHistory.length === 0 ? (
                                                    <p className="text-sm text-gray-500 ml-2">No usage logs found for this fabric.</p>
                                                ) : (
                                                    <div className="space-y-2">
                                                        {transactionHistory.map((tx) => (
                                                            <div key={tx.id} className="bg-white border border-gray-200 rounded-lg overflow-hidden">
                                                                {/* Summary Bar */}
                                                                <button
                                                                    type="button"
                                                                    onClick={() => toggleTransactionDetails(tx.id)}
                                                                    className="w-full flex justify-between items-center p-3 text-left hover:bg-gray-50 transition duration-100"
                                                                >
                                                                    <div className="flex items-center text-sm font-semibold">
                                                                        <span className="text-indigo-800 mr-3">{tx.orderNumber || 'N/A'}</span>
                                                                        <span className="text-red-600 mr-3 font-extrabold">-{tx.amountUsed.toFixed(2)} {fabric.unit}</span>
                                                                        <span className="text-gray-500 font-normal flex items-center"><Clock className="w-4 h-4 mr-1 ml-2" /> {formatTimestamp(tx.usedAt)}</span>
                                                                    </div>
                                                                    {expandedTransactionId === tx.id ? <ChevronDown className="w-5 h-5 text-gray-600" /> : <ChevronRight className="w-5 h-5 text-gray-600" />}
                                                                </button>

                                                                {/* Expanded Details */}
                                                                {expandedTransactionId === tx.id && (
                                                                    <div className="p-3 pt-0 border-t border-gray-200 bg-gray-50 text-xs space-y-1">
                                                                        <p><span className="font-semibold text-gray-700">Product:</span> {tx.productName || 'N/A'} (Size: {tx.size || 'N/A'})</p>
                                                                        <p><span className="font-semibold text-gray-700">Customer:</span> {tx.customerName || 'N/A'}</p>
                                                                        <p><span className="font-semibold text-gray-700">Logged By:</span> {tx.usedByEmail || 'N/A'} at {formatTimestamp(tx.usedAt, true)}</p>
                                                                    </div>
                                                                )}
                                                            </div>
                                                        ))}
                                                    </div>
                                                )}

                                            </div>
                                        )}


                                    </div>
                                ))}
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        // Render the App
        const container = document.getElementById('root');
        // Use React 18's createRoot API
        const root = ReactDOM.createRoot(container);
        root.render(<App />);
    </script>
</body>

</html>